{% extends "base.html" %}

{% block title %}Todo - Time Management{% endblock %}

{% block content %}
    <style>
    /* ========== ÂÆåÊàêÂ∫¶ËøõÂ∫¶Êù°ÂºπÁ™óÊ†∑Âºè ========== */
    .progress-dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.2s ease;
    }
    .progress-dialog {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 16px;
        padding: 24px;
        min-width: 320px;
        max-width: 90vw;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease;
    }
    [data-theme="dark"] .progress-dialog {
        background: rgba(30, 30, 40, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    @keyframes slideUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .progress-dialog-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-color, #1f2937);
        margin-bottom: 12px;
        text-align: center;
    }
    .progress-dialog-task {
        font-size: 14px;
        color: var(--text-muted, #6b7280);
        margin-bottom: 20px;
        text-align: center;
        padding: 8px 12px;
        background: var(--bg-secondary, #f3f4f6);
        border-radius: 8px;
        max-height: 60px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .progress-slider-container {
        margin: 24px 0;
        text-align: center;
    }
    .progress-slider {
        width: 100%;
        height: 8px;
        -webkit-appearance: none;
        appearance: none;
        background: linear-gradient(to right,
            #4f46e5 0%,
            #4f46e5 var(--val, 0%),
            #e5e7eb var(--val, 0%),
            #e5e7eb 100%
        );
        border-radius: 4px;
        outline: none;
        cursor: pointer;
    }
    .progress-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 24px;
        height: 24px;
        background: white;
        border: 3px solid #4f46e5;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s;
    }
    .progress-slider::-webkit-slider-thumb:hover {
        transform: scale(1.1);
    }
    .progress-slider::-moz-range-thumb {
        width: 24px;
        height: 24px;
        background: white;
        border: 3px solid #4f46e5;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    .progress-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-color, #1f2937);
        margin-top: 16px;
        transition: all 0.3s;
    }
    .progress-value.complete {
        color: #10b981;
        transform: scale(1.1);
    }
    .progress-dialog-buttons {
        display: flex;
        gap: 12px;
        margin-top: 20px;
    }
    .progress-btn {
        flex: 1;
        padding: 12px 20px;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    .progress-btn.cancel {
        background: var(--bg-secondary, #e5e7eb);
        color: var(--text-muted, #6b7280);
    }
    .progress-btn.cancel:hover {
        background: #d1d5db;
    }
    .progress-btn.confirm {
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        color: white;
    }
    .progress-btn.confirm:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
    }
    .progress-btn.confirm.complete {
        background: linear-gradient(135deg, #10b981, #059669);
    }

    /* ========== ÁºñËæëÂºπÁ™óÊ†∑Âºè ========== */
    .edit-dialog {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 16px;
        padding: 24px;
        min-width: 400px;
        max-width: 90vw;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease;
    }
    [data-theme="dark"] .edit-dialog {
        background: rgba(30, 30, 40, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .edit-dialog-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-color, #1f2937);
        margin-bottom: 20px;
        text-align: center;
    }
    .edit-form {
        margin-bottom: 20px;
    }
    .edit-field {
        margin-bottom: 16px;
    }
    .edit-field label {
        display: block;
        font-size: 13px;
        color: var(--text-muted, #6b7280);
        margin-bottom: 6px;
        font-weight: 500;
    }
    .edit-field input,
    .edit-field textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border-color, #e5e7eb);
        border-radius: 10px;
        font-size: 14px;
        background: var(--bg-color, #fff);
        color: var(--text-color, #1f2937);
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    .edit-field input:focus,
    .edit-field textarea:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    .edit-field textarea {
        resize: vertical;
        min-height: 80px;
    }
    .edit-row {
        display: flex;
        gap: 16px;
    }
    .edit-row .edit-field {
        flex: 1;
    }

    /* ========== Êñ∞ÁâàÊ∑ªÂä†‰ªªÂä°ÂºπÁ™óÊ†∑Âºè ========== */
    .modal-wide {
        width: 560px !important;
        max-width: 90vw !important;
    }
    .task-input-large {
        width: 100%;
        padding: 14px 16px !important;
        font-size: 16px !important;
        border-radius: 10px !important;
    }
    .form-row {
        display: flex;
        gap: 20px;
        align-items: flex-start;
    }
    .form-group-inline {
        flex: 1;
    }
    .form-group-inline label {
        margin-bottom: 8px;
    }
    .tab-selector-horizontal {
        display: flex;
        gap: 8px;
    }
    .tab-btn {
        padding: 8px 16px;
        border: 1px solid var(--border-color, #e5e7eb);
        background: var(--bg-secondary, #f9fafb);
        color: var(--text-muted, #6b7280);
        border-radius: 8px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
    }
    .tab-btn:hover {
        background: var(--bg-color, #fff);
        border-color: var(--accent-color, #4f46e5);
    }
    .tab-btn.active {
        background: var(--accent-color, #4f46e5);
        color: white;
        border-color: var(--accent-color, #4f46e5);
    }
    .quadrant-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }
    .quadrant-cell {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        border: 2px solid var(--border-color, #e5e7eb);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--bg-secondary, #f9fafb);
    }
    .quadrant-cell:hover {
        border-color: var(--accent-color, #4f46e5);
        background: var(--bg-color, #fff);
    }
    .quadrant-cell.selected {
        border-color: var(--accent-color, #4f46e5);
        background: rgba(79, 70, 229, 0.08);
    }
    .quadrant-cell input[type="radio"] {
        display: none;
    }
    .cell-icon {
        font-size: 20px;
    }
    .cell-text {
        font-size: 14px;
        color: var(--text-color, #1f2937);
    }

    /* ========== ‰ªªÂä°ËØ¶ÊÉÖÂç°Áâá - Apple ÊØõÁéªÁíÉÊïàÊûú ========== */
    .task-card-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 999;
        background: rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(2px);
        animation: fadeIn 0.2s ease;
    }
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    .task-card {
        position: fixed;
        z-index: 1000;
        min-width: 320px;
        max-width: 400px;
        animation: cardSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes cardSlideIn {
        from {
            opacity: 0;
            transform: scale(0.9) translateY(10px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }
    .task-card-content {
        position: relative;
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0.85) 0%,
            rgba(255, 255, 255, 0.75) 50%,
            rgba(255, 255, 255, 0.8) 100%
        );
        backdrop-filter: blur(40px) saturate(180%);
        -webkit-backdrop-filter: blur(40px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-radius: 20px;
        padding: 20px;
        box-shadow:
            0 0 0 0.5px rgba(255, 255, 255, 0.6) inset,
            0 25px 50px rgba(0, 0, 0, 0.15),
            0 10px 30px rgba(0, 0, 0, 0.1),
            0 0 1px rgba(0, 0, 0, 0.1);
    }
    /* È°∂ÈÉ®È´òÂÖâ */
    .task-card-content::before {
        content: '';
        position: absolute;
        top: 0;
        left: 15%;
        right: 15%;
        height: 1px;
        background: linear-gradient(90deg,
            transparent,
            rgba(255, 255, 255, 0.9) 30%,
            rgba(255, 255, 255, 1) 50%,
            rgba(255, 255, 255, 0.9) 70%,
            transparent
        );
        border-radius: 1px;
    }
    /* ÂÜÖÈÉ®ÂÖâÊ≥Ω */
    .task-card-content::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 50%;
        background: linear-gradient(180deg,
            rgba(255, 255, 255, 0.3) 0%,
            transparent 100%
        );
        border-radius: 20px 20px 0 0;
        pointer-events: none;
    }
    .task-card-pointer {
        position: absolute;
        width: 16px;
        height: 16px;
        background: linear-gradient(135deg,
            rgba(255, 255, 255, 0.85) 0%,
            rgba(255, 255, 255, 0.75) 100%
        );
        backdrop-filter: blur(40px);
        border: 1px solid rgba(255, 255, 255, 0.5);
        border-right: none;
        border-bottom: none;
        transform: rotate(45deg);
        top: 20px;
        left: -8px;
        box-shadow: -2px -2px 4px rgba(0, 0, 0, 0.05);
    }
    .task-card-text {
        position: relative;
        z-index: 1;
        font-size: 16px;
        line-height: 1.6;
        color: #1f2937;
        font-weight: 500;
        margin-bottom: 16px;
        word-wrap: break-word;
    }
    .task-card-divider {
        height: 1px;
        background: linear-gradient(90deg,
            transparent,
            rgba(0, 0, 0, 0.1) 20%,
            rgba(0, 0, 0, 0.15) 50%,
            rgba(0, 0, 0, 0.1) 80%,
            transparent
        );
        margin: 12px 0;
    }
    .task-card-meta {
        position: relative;
        z-index: 1;
    }
    .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 0;
        font-size: 13px;
    }
    .meta-icon {
        font-size: 14px;
    }
    .meta-label {
        color: #6b7280;
    }
    .meta-value {
        color: #374151;
        font-weight: 500;
    }
    .task-card-progress-bar {
        width: 100%;
        height: 6px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 3px;
        margin: 8px 0 12px 0;
        overflow: hidden;
    }
    .task-card-progress-bar .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4f46e5, #7c3aed);
        border-radius: 3px;
        transition: width 0.3s ease;
    }
    .task-card-actions {
        position: relative;
        z-index: 1;
        display: flex;
        gap: 10px;
        margin-top: 16px;
        justify-content: flex-end;
    }
    .card-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 10px 18px;
        border: none;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    .card-btn-edit {
        background: rgba(79, 70, 229, 0.1);
        color: #4f46e5;
    }
    .card-btn-edit:hover {
        background: #4f46e5;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
    }
    .card-btn-complete {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
    }
    .card-btn-complete:hover {
        background: #10b981;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    /* Ê∑±Ëâ≤Ê®°ÂºèÈÄÇÈÖç */
    @media (prefers-color-scheme: dark) {
        .task-card-content {
            background: linear-gradient(
                135deg,
                rgba(30, 30, 40, 0.9) 0%,
                rgba(40, 40, 55, 0.85) 50%,
                rgba(35, 35, 50, 0.88) 100%
            );
            border-color: rgba(255, 255, 255, 0.15);
        }
        .task-card-pointer {
            background: linear-gradient(135deg,
                rgba(30, 30, 40, 0.9) 0%,
                rgba(40, 40, 55, 0.85) 100%
            );
            border-color: rgba(255, 255, 255, 0.15);
        }
        .task-card-text {
            color: #f3f4f6;
        }
        .meta-label {
            color: #9ca3af;
        }
        .meta-value {
            color: #e5e7eb;
        }
    }

    /* ‰ªªÂä°ÁºñËæëËæìÂÖ•Ê°ÜÊ†∑Âºè */
    .task-edit-input {
        width: 100%;
        padding: 4px 8px;
        border: 2px solid var(--accent-color, #4f46e5);
        border-radius: 4px;
        font-size: inherit;
        font-family: inherit;
        background: var(--bg-color, #fff);
        color: var(--text-color, #1f2937);
        outline: none;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    .task-edit-input:focus {
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
    }
    .task-text.editing {
        padding: 0;
    }
    /* ‰ªªÂä°Êìç‰ΩúÊåâÈíÆÁªÑ */
    .task-actions {
        display: flex;
        gap: 4px;
        opacity: 0;
        transition: opacity 0.2s;
    }
    .task-item:hover .task-actions {
        opacity: 1;
    }
    .task-edit, .task-delete {
        width: 24px;
        height: 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.2s;
    }
    .task-edit {
        background: var(--bg-secondary, #f3f4f6);
        color: var(--text-muted, #6b7280);
    }
    .task-edit:hover {
        background: var(--accent-color, #4f46e5);
        color: white;
    }
    .task-delete {
        background: var(--bg-secondary, #f3f4f6);
        color: var(--text-muted, #6b7280);
    }
    .task-delete:hover {
        background: #ef4444;
        color: white;
    }

    /* ========== Áªü‰∏Ä‰ªªÂä°ÂºπÁ™ó ========== */
    .task-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
        z-index: 10000;
        display: flex;
        align-items: flex-start;  /* È°∂ÈÉ®ÂØπÈΩêÔºåÂ±ïÂºÄÊó∂Âêë‰∏ãÂª∂Â±ï */
        justify-content: center;
        padding-top: 8vh;         /* Ë∑ùÈ°∂ÈÉ®ÁïôÁôΩ */
        animation: fadeIn 0.2s ease;
    }
    .task-modal {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 12px;
        width: 720px;
        max-width: 95vw;
        max-height: 85vh;
        display: flex;
        flex-direction: column;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideDown 0.3s ease;  /* Êîπ‰∏∫‰ªé‰∏äÂæÄ‰∏ã */
    }
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    [data-theme="dark"] .task-modal {
        background: rgba(30, 30, 40, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    /* Ê†áÈ¢òÊ†èÔºöÊ†áÈ¢òËæìÂÖ• + ÊåâÈíÆÁªÑ */
    .task-modal-header {
        display: flex;
        align-items: flex-start;
        padding: 16px 20px 12px;
        gap: 12px;
        border-bottom: 1px solid rgba(0,0,0,0.06);
        flex-shrink: 0;
    }
    .task-modal-header .title-input {
        flex: 1;
        font-size: 18px;
        font-weight: 600;
        border: none;
        background: transparent;
        padding: 4px 0;
        color: var(--text-color, #1f2937);
        resize: none;
        line-height: 1.4;
        max-height: 52px;
        overflow: hidden;
    }
    .task-modal-header .title-input:focus {
        outline: none;
        border-bottom: 2px solid #4f46e5;
    }
    .task-modal-header .title-input[readonly] {
        border-bottom: none;
        background: transparent;
    }
    .header-actions {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
        padding-top: 4px;
    }
    .header-btn {
        padding: 6px 14px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .header-btn.edit-btn {
        background: #4f46e5;
        color: white;
    }
    .header-btn.edit-btn:hover {
        background: #4338ca;
    }
    .header-btn.close-btn {
        background: var(--bg-secondary, #f3f4f6);
        color: var(--text-muted, #6b7280);
    }
    .header-btn.close-btn:hover {
        background: #e5e7eb;
        color: #374151;
    }
    /* ‰∏ª‰ΩìÔºöÂ∑¶Â±ûÊÄß + Âè≥ÂÜÖÂÆπ */
    .task-modal-body {
        display: flex;
        flex: 1;
        min-height: 0;
        overflow: hidden;
    }
    /* Â∑¶Ê†èÔºöÂ±ûÊÄßÂå∫ */
    .task-modal-left {
        width: 200px;
        flex-shrink: 0;
        padding: 16px;
        border-right: 1px solid rgba(0,0,0,0.06);
        overflow-y: auto;
        background: rgba(0,0,0,0.02);
    }
    .prop-group {
        margin-bottom: 14px;
    }
    .prop-group label {
        display: block;
        font-size: 11px;
        color: var(--text-muted, #6b7280);
        margin-bottom: 4px;
        font-weight: 500;
    }
    .prop-group input,
    .prop-group select {
        width: 100%;
        padding: 7px 10px;
        border: 1px solid var(--border-color, #e5e7eb);
        border-radius: 6px;
        font-size: 13px;
        background: var(--bg-color, #fff);
        color: var(--text-color, #1f2937);
    }
    .prop-group input:focus,
    .prop-group select:focus {
        outline: none;
        border-color: #4f46e5;
    }
    .prop-group input[readonly],
    .prop-group select:disabled {
        background: var(--bg-secondary, #f9fafb);
        cursor: default;
    }
    /* ËøõÂ∫¶ÊªëÂùóÔºàÂ∑¶Ê†èÔºâ */
    .progress-slider {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .progress-slider input[type="range"] {
        flex: 1;
        height: 6px;
        -webkit-appearance: none;
        background: linear-gradient(to right,
            #4f46e5 0%,
            #4f46e5 var(--val, 0%),
            #e5e7eb var(--val, 0%),
            #e5e7eb 100%
        );
        border-radius: 3px;
        border: none;
        padding: 0;
    }
    .progress-slider input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 14px;
        height: 14px;
        background: white;
        border: 2px solid #4f46e5;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .progress-slider .progress-value {
        min-width: 36px;
        text-align: right;
        font-size: 12px;
        font-weight: 500;
        color: var(--text-muted);
    }
    /* Ë±°ÈôêÈÄâÊã©ÔºàÂ∑¶Ê†èÁ¥ßÂáëÁâàÔºâ */
    .quadrant-select-compact {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 4px;
    }
    .quadrant-select-compact .q-option {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 2px;
        padding: 6px 4px;
        border: 1px solid var(--border-color, #e5e7eb);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s;
        text-align: center;
    }
    .quadrant-select-compact .q-option:hover {
        border-color: #4f46e5;
    }
    .quadrant-select-compact .q-option.selected {
        background: rgba(79, 70, 229, 0.1);
        border-color: #4f46e5;
    }
    .quadrant-select-compact .q-option input {
        display: none;
    }
    .quadrant-select-compact .q-icon {
        font-size: 14px;
    }
    .quadrant-select-compact .q-text {
        font-size: 9px;
        color: var(--text-muted, #6b7280);
        line-height: 1.2;
    }
    .quadrant-select-compact .q-option.selected .q-text {
        color: #4f46e5;
    }
    .quadrant-select-compact .q-option.disabled {
        opacity: 0.6;
        cursor: default;
        pointer-events: none;
    }
    /* Êó∂Èó¥ÊÆµÊåâÈíÆÁªÑ */
    .tab-buttons {
        display: flex;
        gap: 4px;
    }
    .tab-btn {
        flex: 1;
        padding: 6px 8px;
        border: 1px solid var(--border-color, #e5e7eb);
        border-radius: 6px;
        background: var(--bg-color, #fff);
        font-size: 11px;
        cursor: pointer;
        transition: all 0.15s;
    }
    .tab-btn:hover {
        border-color: #4f46e5;
    }
    .tab-btn.selected {
        background: #4f46e5;
        color: white;
        border-color: #4f46e5;
    }
    .tab-btn:disabled {
        opacity: 0.5;
        cursor: default;
    }
    /* ÂÖÉ‰ø°ÊÅØÔºàÂ∑¶Ê†èÔºâ */
    .meta-section {
        padding-top: 12px;
        margin-top: 12px;
        border-top: 1px solid rgba(0,0,0,0.06);
    }
    .meta-item {
        font-size: 11px;
        color: var(--text-muted, #9ca3af);
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    /* Âè≥Ê†èÔºöÂÜÖÂÆπÂå∫ */
    .task-modal-right {
        flex: 1;
        padding: 16px;
        display: flex;
        flex-direction: column;
    }
    .task-modal-right textarea {
        flex: 1;
        width: 100%;
        min-height: 200px;
        padding: 12px;
        border: 1px solid var(--border-color, #e5e7eb);
        border-radius: 8px;
        font-size: 14px;
        line-height: 1.6;
        resize: vertical;
        background: var(--bg-color, #fff);
        color: var(--text-color, #1f2937);
    }
    .task-modal-right textarea:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    .task-modal-right textarea[readonly] {
        background: var(--bg-secondary, #f9fafb);
        cursor: text;
        resize: none;
        transition: background 0.2s ease, border-color 0.2s ease;
    }
    .task-modal-right textarea[readonly]:hover {
        background: rgba(79, 70, 229, 0.05);
        border-color: rgba(79, 70, 229, 0.3);
    }
    /* ÊªöÂä®Êù°ÁæéÂåñ */
    .task-modal-left::-webkit-scrollbar,
    .task-modal-right textarea::-webkit-scrollbar {
        width: 5px;
    }
    .task-modal-left::-webkit-scrollbar-thumb,
    .task-modal-right textarea::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.15);
        border-radius: 3px;
    }
    /* ÂÖºÂÆπÊóßÊ†∑Âºè */
    .task-modal-field { margin-bottom: 14px; }
    .task-modal-row { display: flex; gap: 12px; }
    .task-modal-row .task-modal-field { flex: 1; }
    /* ËøõÂ∫¶ÊªëÂùó */
    .progress-field {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .progress-field input[type="range"] {
        flex: 1;
        height: 6px;
        -webkit-appearance: none;
        appearance: none;
        background: linear-gradient(to right, #4f46e5 0%, #4f46e5 var(--val, 0%), #e5e7eb var(--val, 0%), #e5e7eb 100%);
        border-radius: 3px;
        border: none;
        padding: 0;
    }
    .progress-field input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        background: white;
        border: 2px solid #4f46e5;
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .progress-field input[type="range"]:disabled {
        opacity: 0.6;
    }
    .progress-field input[type="range"]:disabled::-webkit-slider-thumb {
        cursor: default;
    }
    .progress-value {
        min-width: 40px;
        text-align: right;
        font-weight: 600;
        color: var(--text-color, #1f2937);
    }
    /* Ë±°ÈôêÈÄâÊã©Âô® */
    .quadrant-select {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }
    .quadrant-option {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        border: 1px solid var(--border-color, #e5e7eb);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--bg-color, #fff);
    }
    .quadrant-option:hover {
        border-color: #4f46e5;
    }
    .quadrant-option.selected {
        border-color: #4f46e5;
        background: rgba(79, 70, 229, 0.05);
    }
    .quadrant-option.disabled {
        opacity: 0.6;
        cursor: default;
    }
    .quadrant-option input {
        display: none;
    }
    .quadrant-option .icon {
        font-size: 16px;
    }
    .quadrant-option .text {
        font-size: 13px;
        color: var(--text-color, #1f2937);
    }
    /* Â∫ïÈÉ®ÊåâÈíÆ */
    .task-modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        padding: 16px 24px;
        border-top: 1px solid var(--border-color, #e5e7eb);
        flex-shrink: 0;
        background: inherit;
    }
    @media (max-height: 700px) {
        .task-modal-footer {
            padding: 12px 16px;
        }
        .task-modal-body {
            padding: 8px 16px 16px;
        }
        .task-modal-header {
            padding: 10px 12px 0;
        }
    }
    .task-modal-btn {
        padding: 10px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    .task-modal-btn.secondary {
        background: var(--bg-secondary, #e5e7eb);
        color: var(--text-muted, #6b7280);
    }
    .task-modal-btn.secondary:hover {
        background: #d1d5db;
    }
    .task-modal-btn.primary {
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        color: white;
    }
    .task-modal-btn.primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
    }

    /* ========== Êó∂Èó¥‰ø°ÊÅØÂå∫ ========== */
    .task-modal-meta {
        padding: 12px 24px;
        background: rgba(0, 0, 0, 0.02);
        border-top: 1px solid rgba(0, 0, 0, 0.06);
    }
    .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.85rem;
        color: var(--text-muted, #6b7280);
        margin-bottom: 4px;
    }
    .meta-item:last-child {
        margin-bottom: 0;
    }
    .meta-icon {
        font-size: 0.9rem;
    }

    /* ========== ÂèòÊõ¥ËÆ∞ÂΩïÂå∫ÔºàÂÖ®ÂÆΩÂ∫ïÈÉ®Ôºâ ========== */
    .changelog-section.changelog-full-width {
        padding: 12px 24px;
        border-top: 1px solid rgba(0, 0, 0, 0.06);
    }
    .changelog-toggle {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: rgba(0, 0, 0, 0.03);
        border: none;
        border-radius: 6px;
        font-size: 0.85rem;
        color: var(--text-muted, #6b7280);
        cursor: pointer;
        transition: all 0.2s;
        width: auto;
    }
    .changelog-toggle:hover {
        background: rgba(0, 0, 0, 0.06);
        color: var(--text-secondary, #374151);
    }
    .changelog-arrow {
        transition: transform 0.2s;
        margin-left: 4px;
    }
    .changelog-toggle.expanded .changelog-arrow {
        transform: rotate(180deg);
    }
    .changelog-list {
        margin-top: 0;
        max-height: 0;
        overflow: hidden;
        padding: 0 12px;
        background: rgba(0, 0, 0, 0.02);
        border-radius: 6px;
        transition: max-height 0.3s ease, margin-top 0.3s ease, padding 0.3s ease;
    }
    .changelog-list.expanded {
        margin-top: 10px;
        max-height: 150px;
        overflow-y: auto;
        padding: 8px 12px;
    }
    @media (max-height: 700px) {
        .changelog-list.expanded {
            max-height: 100px;
        }
    }
    .changelog-item {
        display: flex;
        gap: 16px;
        padding: 5px 0;
        font-size: 0.8rem;
        border-bottom: 1px dashed rgba(0, 0, 0, 0.06);
    }
    .changelog-item:last-child {
        border-bottom: none;
    }
    .changelog-time {
        color: var(--text-muted, #9ca3af);
        white-space: nowrap;
        min-width: 100px;
        flex-shrink: 0;
    }
    .changelog-text {
        color: var(--text-secondary, #6b7280);
        flex: 1;
    }
    .changelog-empty {
        color: var(--text-muted, #9ca3af);
        font-style: italic;
        font-size: 0.8rem;
        padding: 8px 0;
    }

    /* ========== ËøõÂ∫¶Êù° ========== */
    /* ËøõÂ∫¶ÂúÜÁéØ */
    .progress-ring {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: conic-gradient(
            #4f46e5 calc(var(--progress, 0) * 3.6deg),
            #e5e7eb calc(var(--progress, 0) * 3.6deg)
        );
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
        flex-shrink: 0;
        transition: transform 0.15s;
    }
    .progress-ring:hover {
        transform: scale(1.1);
    }
    .progress-ring::before {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        background: var(--bg-color, #fff);
        border-radius: 50%;
    }
    .progress-ring-text {
        position: relative;
        font-size: 8px;
        font-weight: 600;
        color: #4f46e5;
    }
    /* ÊóßËøõÂ∫¶Êù°Ê†∑ÂºèÔºà‰øùÁïôÂÖºÂÆπÔºâ */
    .task-progress-bar {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 4px;
    }
    .task-progress-track {
        flex: 1;
        height: 6px;
        background: rgba(0, 0, 0, 0.08);
        border-radius: 3px;
        overflow: hidden;
    }
    .task-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        border-radius: 3px;
        transition: width 0.3s ease;
    }
    .task-progress-text {
        font-size: 0.75rem;
        font-weight: 600;
        color: #667eea;
        min-width: 36px;
        text-align: right;
    }

    /* ========== ÊØèÊó•‰æãË°åÊåâÈíÆÂíåÈù¢Êùø ========== */
    .btn-routine {
        padding: 0.5rem 1rem;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        position: relative;
        overflow: hidden;
    }
    .btn-routine:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    .tabs-divider {
        width: 1px;
        height: 24px;
        background: rgba(0, 0, 0, 0.1);
        margin: 0 0.5rem;
    }

    /* ========== ‰ªªÂä°Áä∂ÊÄÅÊóãËΩ¨ËæπÊ°ÜÂä®Êïà ========== */
    @property --btn-angle {
        syntax: '<angle>';
        initial-value: 0deg;
        inherits: false;
    }
    @keyframes btn-border-rotate {
        0% { --btn-angle: 0deg; }
        100% { --btn-angle: 360deg; }
    }
    .btn-routine.has-pending,
    .matrix-tab[data-tab="today"].has-pending {
        position: relative;
        overflow: visible;
        isolation: isolate;
        background: transparent !important;
    }
    /* ËÉåÊôØÂ±Ç */
    .btn-routine.has-pending::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: linear-gradient(135deg, #667eea, #764ba2);
        z-index: -1;
    }
    .matrix-tab[data-tab="today"].has-pending::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: inherit;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        z-index: -1;
    }
    .btn-routine.has-pending::before,
    .matrix-tab[data-tab="today"].has-pending::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        border-radius: inherit;
        padding: 2px;
        background: conic-gradient(
            from var(--btn-angle, 0deg),
            transparent 0%,
            transparent 92%,
            rgba(255, 204, 188, 0.5) 93%,
            rgba(255, 171, 145, 0.6) 94%,
            rgba(255, 138, 128, 0.8) 95%,
            #ff5252 97%,
            #ff6b6b 98%,
            transparent 100%
        );
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        animation: btn-border-rotate var(--rotate-speed, 4s) linear infinite;
        z-index: 0;
        pointer-events: none;
    }
    .btn-routine.speed-fast::before,
    .matrix-tab.speed-fast::before {
        --rotate-speed: 2s;
    }
    .btn-routine.speed-slow::before,
    .matrix-tab.speed-slow::before {
        --rotate-speed: 5s;
    }
    .routine-panel-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(2px);
        z-index: 10000;
        animation: fadeIn 0.2s ease;
    }
    .routine-panel {
        position: absolute;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 16px;
        width: 360px;
        max-width: calc(100vw - 40px);
        max-height: 60vh;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        animation: slideDown 0.2s ease;
        display: flex;
        flex-direction: column;
    }
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    [data-theme="dark"] .routine-panel {
        background: rgba(30, 30, 40, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .routine-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    }
    .routine-header h3 {
        margin: 0;
        font-size: 1.2rem;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    .routine-close {
        background: rgba(102, 126, 234, 0.15);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(102, 126, 234, 0.2);
        border-radius: 8px;
        font-size: 0.85rem;
        font-weight: 600;
        color: #667eea;
        cursor: pointer;
        padding: 0.5rem 1.2rem;
        transition: all 0.2s;
    }
    .routine-close:hover {
        background: rgba(102, 126, 234, 0.25);
        transform: translateY(-1px);
    }
    .routine-list {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        min-height: 200px;
        max-height: 400px;
    }
    .routine-empty {
        text-align: center;
        color: #9ca3af;
        padding: 2rem;
    }
    .routine-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: var(--bg-secondary, #f9fafb);
        border-radius: 10px;
        margin-bottom: 0.5rem;
        transition: all 0.2s;
    }
    .routine-item:hover {
        background: var(--bg-hover, #f3f4f6);
    }
    .routine-item.completed {
        opacity: 0.6;
    }
    .routine-item.completed .routine-text {
        text-decoration: line-through;
        color: #9ca3af;
    }
    .routine-checkbox {
        width: 20px;
        height: 20px;
        border: 2px solid #d1d5db;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
    }
    .routine-checkbox:hover {
        border-color: #f5576c;
    }
    .routine-checkbox.checked {
        background: linear-gradient(135deg, #f093fb, #f5576c);
        border-color: transparent;
        color: white;
    }
    .routine-text {
        flex: 1;
        font-size: 0.95rem;
        color: var(--text-color, #1f2937);
    }
    .routine-delete {
        background: none;
        border: none;
        color: #d1d5db;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 0;
        opacity: 0;
        transition: all 0.2s;
    }
    .routine-item:hover .routine-delete {
        opacity: 1;
    }
    .routine-delete:hover {
        color: #ef4444;
    }
    .routine-footer {
        display: flex;
        gap: 0.5rem;
        padding: 1rem;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
    }
    .routine-footer input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        font-size: 0.95rem;
        outline: none;
    }
    .routine-footer input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .btn-add-routine {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 1.5rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .btn-add-routine:hover {
        transform: scale(1.05);
    }
    </style>
    <div class="toast-container" id="toast-container"></div>

    <!-- ÊØèÊó•‰æãË°åÈù¢Êùø -->
    <div class="routine-panel-overlay" id="routine-panel-overlay" style="display:none;" onclick="toggleRoutinePanel()">
        <div class="routine-panel" onclick="event.stopPropagation()">
            <div class="routine-header">
                <h3>üî• ‰Ω†ÁúüÊòØÂº∫ÁöÑÂèØÊÄï</h3>
                <button class="routine-close" onclick="toggleRoutinePanel()">Á°ÆËÆ§</button>
            </div>
            <div class="routine-list" id="routine-list">
                <div class="routine-empty">ÊöÇÊó†‰æãË°å‰ªªÂä°</div>
            </div>
            <div class="routine-footer">
                <input type="text" id="routine-input" placeholder="Ê∑ªÂä†‰æãË°å‰ªªÂä°..." onkeypress="if(event.key==='Enter')addRoutine()">
                <button class="btn-add-routine" onclick="addRoutine()">+</button>
            </div>
        </div>
    </div>

    <div class="todo-main-layout">
    <div class="todo-matrix-container">
        <!-- ÂêçË®ÄÊ†è -->
        <div class="page-header compact">
            <div class="header-left">
                <p class="quote-text" id="quote-text">{{ quote }}</p>
            </div>
            <button class="btn-shuffle" onclick="shuffleQuote()">Êç¢‰∏Ä‰∏™</button>
        </div>
        <!-- Tab Navigation -->
        <div class="matrix-tabs">
            <button class="btn-routine" onclick="toggleRoutinePanel()">‰æãË°å</button>
            <div class="tabs-divider"></div>
            <button class="matrix-tab active" data-tab="today" onclick="switchTab('today')">
                Today
                <span class="tab-count" id="count-today">0</span>
            </button>
            <button class="matrix-tab" data-tab="week" onclick="switchTab('week')">
                This Week
                <span class="tab-count" id="count-week">0</span>
            </button>
            <button class="matrix-tab" data-tab="month" onclick="switchTab('month')">
                Next 30 Days
                <span class="tab-count" id="count-month">0</span>
            </button>
            <div class="tab-actions">
                <button class="btn-add-task" onclick="showAddModal()">+ Ê∑ªÂä†‰ªªÂä°</button>
            </div>
        </div>

        <!-- Drop zone for moving to other tabs with quadrant options -->
        <div class="tab-drop-zones" id="tab-drop-zones" style="display:none;">
            <div class="tab-drop-zone" data-target-tab="today">
                <div class="drop-zone-title">ÊãñÂà∞ Today</div>
                <div class="drop-zone-matrix">
                    <div class="drop-zone-quadrants">
                        <div class="drop-quadrant" data-target-tab="today" data-target-quadrant="important-urgent">üî•</div>
                        <div class="drop-quadrant" data-target-tab="today" data-target-quadrant="important-not-urgent">üéØ</div>
                        <div class="drop-quadrant" data-target-tab="today" data-target-quadrant="not-important-urgent">üì•</div>
                        <div class="drop-quadrant" data-target-tab="today" data-target-quadrant="not-important-not-urgent">‚ö°</div>
                    </div>
                </div>
            </div>
            <div class="tab-drop-zone" data-target-tab="week">
                <div class="drop-zone-title">ÊãñÂà∞ This Week</div>
                <div class="drop-zone-matrix">
                    <div class="drop-zone-quadrants">
                        <div class="drop-quadrant" data-target-tab="week" data-target-quadrant="important-urgent">üî•</div>
                        <div class="drop-quadrant" data-target-tab="week" data-target-quadrant="important-not-urgent">üéØ</div>
                        <div class="drop-quadrant" data-target-tab="week" data-target-quadrant="not-important-urgent">üì•</div>
                        <div class="drop-quadrant" data-target-tab="week" data-target-quadrant="not-important-not-urgent">‚ö°</div>
                    </div>
                </div>
            </div>
            <div class="tab-drop-zone" data-target-tab="month">
                <div class="drop-zone-title">ÊãñÂà∞ Next 30 Days</div>
                <div class="drop-zone-matrix">
                    <div class="drop-zone-quadrants">
                        <div class="drop-quadrant" data-target-tab="month" data-target-quadrant="important-urgent">üî•</div>
                        <div class="drop-quadrant" data-target-tab="month" data-target-quadrant="important-not-urgent">üéØ</div>
                        <div class="drop-quadrant" data-target-tab="month" data-target-quadrant="not-important-urgent">üì•</div>
                        <div class="drop-quadrant" data-target-tab="month" data-target-quadrant="not-important-not-urgent">‚ö°</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Eisenhower Matrix -->
        <div class="eisenhower-matrix">
            <!-- Matrix Grid -->
            <div class="matrix-grid">
                <!-- Quadrant 1: ‰ºòÂÖàÂ§ÑÁêÜ (ÈªòËÆ§Â±ïÂºÄ) -->
                <div class="quadrant q1" data-quadrant="important-urgent"
                     ondragover="allowDrop(event)" ondragleave="dragLeave(event)" ondrop="dropItem(event)">
                    <div class="quadrant-header" onclick="toggleQuadrant(this)" ondragover="allowDrop(event)" ondrop="dropItem(event)">
                        <span class="quadrant-toggle">‚ñº</span>
                        <span class="quadrant-icon">üî•</span>
                        <span class="quadrant-title">‰ºòÂÖàÂ§ÑÁêÜ</span>
                        <span class="quadrant-count" id="qcount-important-urgent"></span>
                        <button class="btn-quadrant-add" onclick="event.stopPropagation(); showAddModalForQuadrant('important-urgent')">+</button>
                    </div>
                    <div class="quadrant-items" id="items-important-urgent"
                         ondragover="allowDrop(event)" ondrop="dropItem(event)"></div>
                </div>

                <!-- Quadrant 2: Â∞±Á≠â‰Ω†ÁøªÁâåÂ≠ê‰∫Ü (ÈªòËÆ§ÊäòÂè†) -->
                <div class="quadrant q2 collapsed" data-quadrant="important-not-urgent"
                     ondragover="allowDrop(event)" ondragleave="dragLeave(event)" ondrop="dropItem(event)">
                    <div class="quadrant-header" onclick="toggleQuadrant(this)" ondragover="allowDrop(event)" ondrop="dropItem(event)">
                        <span class="quadrant-toggle">‚ñº</span>
                        <span class="quadrant-icon">üéØ</span>
                        <span class="quadrant-title">Â∞±Á≠â‰Ω†ÁøªÁâåÂ≠ê‰∫Ü</span>
                        <span class="quadrant-count" id="qcount-important-not-urgent"></span>
                        <button class="btn-quadrant-add" onclick="event.stopPropagation(); showAddModalForQuadrant('important-not-urgent')">+</button>
                    </div>
                    <div class="quadrant-items" id="items-important-not-urgent"
                         ondragover="allowDrop(event)" ondrop="dropItem(event)"></div>
                </div>

                <!-- Quadrant 3: ÂæÖÂàÜÁ±ª (ÈªòËÆ§ÊäòÂè†) -->
                <div class="quadrant q3 collapsed" data-quadrant="not-important-urgent"
                     ondragover="allowDrop(event)" ondragleave="dragLeave(event)" ondrop="dropItem(event)">
                    <div class="quadrant-header" onclick="toggleQuadrant(this)" ondragover="allowDrop(event)" ondrop="dropItem(event)">
                        <span class="quadrant-toggle">‚ñº</span>
                        <span class="quadrant-icon">üì•</span>
                        <span class="quadrant-title">ÂæÖÂàÜÁ±ª</span>
                        <span class="quadrant-count" id="qcount-not-important-urgent"></span>
                        <button class="btn-quadrant-add" onclick="event.stopPropagation(); showAddModalForQuadrant('not-important-urgent')">+</button>
                    </div>
                    <div class="quadrant-items" id="items-not-important-urgent"
                         ondragover="allowDrop(event)" ondrop="dropItem(event)"></div>
                </div>

                <!-- Quadrant 4: Áü≠Âπ≥Âø´ (ÈªòËÆ§ÊäòÂè†) -->
                <div class="quadrant q4 collapsed" data-quadrant="not-important-not-urgent"
                     ondragover="allowDrop(event)" ondragleave="dragLeave(event)" ondrop="dropItem(event)">
                    <div class="quadrant-header" onclick="toggleQuadrant(this)" ondragover="allowDrop(event)" ondrop="dropItem(event)">
                        <span class="quadrant-toggle">‚ñº</span>
                        <span class="quadrant-icon">‚ö°</span>
                        <span class="quadrant-title">Áü≠Âπ≥Âø´</span>
                        <span class="quadrant-count" id="qcount-not-important-not-urgent"></span>
                        <button class="btn-quadrant-add" onclick="event.stopPropagation(); showAddModalForQuadrant('not-important-not-urgent')">+</button>
                    </div>
                    <div class="quadrant-items" id="items-not-important-not-urgent"
                         ondragover="allowDrop(event)" ondrop="dropItem(event)"></div>
                </div>
            </div>
        </div>

    </div>
    <!-- Âè≥‰æßËæπÊ†è -->
    <div class="right-sidebar">
        <!-- Â∑≤ÂÆåÊàêÂå∫ -->
        <div class="sidebar-section" id="completed-section">
            <div class="section-header" onclick="toggleSidebarSection('completed-section')">
                <h3><span>‚úì</span> Â∑≤ÂÆåÊàê</h3>
                <span class="expand-icon">‚ñ∂</span>
            </div>
            <div class="section-content">
                <div class="section-list" id="completed-list"></div>
            </div>
        </div>
        <!-- Â∑≤Âà†Èô§Âå∫ -->
        <div class="sidebar-section" id="deleted-section">
            <div class="section-header" onclick="toggleSidebarSection('deleted-section')">
                <h3><span>üóë</span> Â∑≤Âà†Èô§</h3>
                <span class="expand-icon">‚ñ∂</span>
            </div>
            <div class="section-content">
                <div class="section-list" id="deleted-list"></div>
            </div>
        </div>
    </div>
    </div>

    <!-- Áªü‰∏Ä‰ªªÂä°ÂºπÁ™óÔºàÊü•Áúã/ÁºñËæë/Êñ∞Âª∫Ôºâ -->
    <div class="task-modal-overlay" id="task-modal-overlay" style="display:none;" onclick="closeTaskModal()">
        <div class="task-modal" onclick="event.stopPropagation()">
            <!-- Ê†áÈ¢òÊ†è -->
            <div class="task-modal-header">
                <textarea id="modal-title" class="title-input" placeholder="‰ªªÂä°Ê†áÈ¢òÔºàÈôê50Â≠óÔºâ" maxlength="50" rows="2"></textarea>
                <div class="header-actions">
                    <button class="header-btn edit-btn" id="header-edit-btn" onclick="switchToEditMode()">ÁºñËæë</button>
                    <button class="header-btn close-btn" onclick="closeTaskModal()">ÂÖ≥Èó≠</button>
                </div>
            </div>
            <!-- ‰∏ª‰ΩìÔºöÂ∑¶Â±ûÊÄß + Âè≥ÂÜÖÂÆπ -->
            <div class="task-modal-body">
                <!-- Â∑¶Ê†èÔºöÂ±ûÊÄß -->
                <div class="task-modal-left">
                    <div class="prop-group">
                        <label>üìÖ ËÆ°ÂàíÂÆåÊàê</label>
                        <input type="date" id="modal-due-date">
                    </div>
                    <div class="prop-group">
                        <label>üë§ Áõ∏ÂÖ≥‰∫∫</label>
                        <input type="text" id="modal-assignee" placeholder="Áõ∏ÂÖ≥‰∫∫Âëò">
                    </div>
                    <div class="prop-group">
                        <label>üïê Êó∂Èó¥ÊÆµ</label>
                        <div class="tab-buttons" id="modal-tab-buttons">
                            <button type="button" class="tab-btn selected" data-tab="today">Today</button>
                            <button type="button" class="tab-btn" data-tab="week">Week</button>
                            <button type="button" class="tab-btn" data-tab="month">Month</button>
                        </div>
                    </div>
                    <div class="prop-group">
                        <label>üìä Ë±°Èôê</label>
                        <div class="quadrant-select-compact" id="modal-quadrant-select">
                            <label class="q-option selected" data-q="important-urgent">
                                <input type="radio" name="modal-quadrant" value="important-urgent" checked>
                                <span class="q-icon">üî•</span><span class="q-text">‰ºòÂÖàÂ§ÑÁêÜ</span>
                            </label>
                            <label class="q-option" data-q="important-not-urgent">
                                <input type="radio" name="modal-quadrant" value="important-not-urgent">
                                <span class="q-icon">üéØ</span><span class="q-text">Á≠â‰Ω†ÁøªÁâå</span>
                            </label>
                            <label class="q-option" data-q="not-important-urgent">
                                <input type="radio" name="modal-quadrant" value="not-important-urgent">
                                <span class="q-icon">üì•</span><span class="q-text">ÂæÖÂàÜÁ±ª</span>
                            </label>
                            <label class="q-option" data-q="not-important-not-urgent">
                                <input type="radio" name="modal-quadrant" value="not-important-not-urgent">
                                <span class="q-icon">‚ö°</span><span class="q-text">Áü≠Âπ≥Âø´</span>
                            </label>
                        </div>
                    </div>
                    <div class="prop-group">
                        <label>ËøõÂ∫¶</label>
                        <div class="progress-slider">
                            <input type="range" id="modal-progress" min="0" max="100" value="0">
                            <span class="progress-value" id="modal-progress-value">0%</span>
                        </div>
                    </div>
                    <!-- ÂÖÉ‰ø°ÊÅØ -->
                    <div class="meta-section" id="modal-meta-section">
                        <div class="meta-item" id="modal-created-at">
                            <span>üìÖ</span>
                            <span class="meta-text">ÂàõÂª∫‰∫é --</span>
                        </div>
                        <div class="meta-item" id="modal-completed-at" style="display:none;">
                            <span>‚úÖ</span>
                            <span class="meta-text">ÂÆåÊàê‰∫é --</span>
                        </div>
                    </div>
                </div>
                <!-- Âè≥Ê†èÔºöÂÜÖÂÆπ -->
                <div class="task-modal-right">
                    <textarea id="modal-content" placeholder="ËØ¶ÁªÜÊèèËø∞„ÄÅÂ§áÊ≥®„ÄÅÁõ∏ÂÖ≥‰ø°ÊÅØ..." onclick="onContentClick()"></textarea>
                </div>
            </div>
            <!-- ÂèòÊõ¥ËÆ∞ÂΩïÔºàÂÖ®ÂÆΩÔºâ -->
            <div class="changelog-section changelog-full-width" id="modal-changelog-section">
                <button class="changelog-toggle" id="changelog-toggle" onclick="toggleChangelog()">
                    <span>üìã ÂèòÊõ¥ËÆ∞ÂΩï</span>
                    <span class="changelog-arrow" id="changelog-arrow">‚ñº</span>
                </button>
                <div class="changelog-list" id="modal-changelog">
                    <div class="changelog-empty">ÊöÇÊó†ÂèòÊõ¥ËÆ∞ÂΩï</div>
                </div>
            </div>
            <!-- Â∫ïÈÉ®ÊåâÈíÆÔºàÁºñËæë/Êñ∞Âª∫Ê®°ÂºèÊòæÁ§∫Ôºâ -->
            <div class="task-modal-footer" id="modal-footer-edit" style="display:none;">
                <button class="task-modal-btn secondary" onclick="closeTaskModal()">ÂèñÊ∂à</button>
                <button class="task-modal-btn primary" id="modal-save-btn" onclick="saveTask()">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>

    <script>
    var currentTab = 'today';
    var allItems = [];
    var showCompleted = true;  // ÈªòËÆ§ÊòæÁ§∫Â∑≤ÂÆåÊàê‰ªªÂä°
    var draggedItem = null;
    var routines = [];  // ÊØèÊó•‰æãË°å‰ªªÂä°

    // ========== ÊØèÊó•‰æãË°åÂäüËÉΩ ==========
    function toggleRoutinePanel() {
        var overlay = document.getElementById('routine-panel-overlay');
        if (overlay.style.display === 'none') {
            overlay.style.display = 'block';
            // ÂÆö‰ΩçÈù¢ÊùøÂà∞"‰æãË°å"ÊåâÈíÆÂè≥‰∏ãËßí
            var btn = document.querySelector('.btn-routine');
            var panel = document.querySelector('.routine-panel');
            if (btn && panel) {
                var rect = btn.getBoundingClientRect();
                panel.style.top = (rect.bottom + 8) + 'px';
                panel.style.left = rect.left + 'px';
            }
            loadRoutines();
        } else {
            overlay.style.display = 'none';
        }
    }

    function loadRoutines() {
        fetch('/api/routines')
            .then(response => response.json())
            .then(data => {
                routines = data.items || [];
                renderRoutines();
            })
            .catch(() => {
                routines = [];
                renderRoutines();
            });
    }

    function renderRoutines() {
        var list = document.getElementById('routine-list');
        if (routines.length === 0) {
            list.innerHTML = '<div class="routine-empty">ÊöÇÊó†‰æãË°å‰ªªÂä°</div>';
            updateButtonAnimations();
            return;
        }
        var html = '';
        routines.forEach(function(r) {
            var checkedClass = r.completed_today ? 'checked' : '';
            var completedClass = r.completed_today ? 'completed' : '';
            html += '<div class="routine-item ' + completedClass + '" data-id="' + r.id + '">' +
                '<div class="routine-checkbox ' + checkedClass + '" onclick="toggleRoutine(\'' + r.id + '\')">' +
                    (r.completed_today ? '‚úì' : '') +
                '</div>' +
                '<span class="routine-text">' + escapeHtml(r.text) + '</span>' +
                '<button class="routine-delete" onclick="deleteRoutine(\'' + r.id + '\')">&times;</button>' +
            '</div>';
        });
        list.innerHTML = html;
        updateButtonAnimations();
    }

    function addRoutine() {
        var input = document.getElementById('routine-input');
        var text = input.value.trim();
        if (!text) return;

        fetch('/api/routines', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: text })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                input.value = '';
                loadRoutines();
                showToast('‰æãË°å‰ªªÂä°Â∑≤Ê∑ªÂä†');
            }
        });
    }

    function toggleRoutine(id) {
        fetch('/api/routines/' + id + '/toggle', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadRoutines();
                }
            });
    }

    function deleteRoutine(id) {
        if (!confirm('Á°ÆÂÆöÂà†Èô§Ê≠§‰æãË°å‰ªªÂä°Ôºü')) return;
        fetch('/api/routines/' + id, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadRoutines();
                    showToast('‰æãË°å‰ªªÂä°Â∑≤Âà†Èô§');
                }
            });
    }


    // ========== ÊåâÈíÆÂä®ÊïàÊõ¥Êñ∞ ==========
    function updateButtonAnimations() {
        // ‰æãË°åÊåâÈíÆ
        var routineBtn = document.querySelector('.btn-routine');
        if (routineBtn) {
            var pendingRoutines = routines.filter(function(r) { return !r.completed_today; }).length;
            var totalRoutines = routines.length;

            if (totalRoutines > 0 && pendingRoutines > 0) {
                routineBtn.classList.add('has-pending');
                var completion = (totalRoutines - pendingRoutines) / totalRoutines;
                routineBtn.classList.toggle('speed-fast', completion < 0.5);
                routineBtn.classList.toggle('speed-slow', completion >= 0.5);
            } else {
                routineBtn.classList.remove('has-pending', 'speed-fast', 'speed-slow');
            }
        }

        // Today ÊåâÈíÆ
        var todayBtn = document.querySelector('.matrix-tab[data-tab="today"]');
        if (todayBtn) {
            var todayItems = allItems.filter(function(i) { return i.tab === 'today' && !i.deleted; });
            var pendingToday = todayItems.filter(function(i) { return !i.completed; }).length;
            var totalToday = todayItems.length;

            if (totalToday > 0 && pendingToday > 0) {
                todayBtn.classList.add('has-pending');
                var completion = (totalToday - pendingToday) / totalToday;
                todayBtn.classList.toggle('speed-fast', completion < 0.5);
                todayBtn.classList.toggle('speed-slow', completion >= 0.5);
            } else {
                todayBtn.classList.remove('has-pending', 'speed-fast', 'speed-slow');
            }
        }
    }


    function shuffleQuote() {
        var btn = document.querySelector('.btn-shuffle');
        btn.classList.add('rolling');

        fetch('/api/quote/random')
            .then(response => response.json())
            .then(data => {
                document.getElementById('quote-text').textContent = data.quote;
                btn.classList.remove('rolling');
            })
            .catch(() => {
                btn.classList.remove('rolling');
            });
    }

    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.matrix-tab').forEach(function(t) {
            t.classList.remove('active');
            if (t.dataset.tab === tab) {
                t.classList.add('active');
            }
        });
        // Êõ¥Êñ∞ modal ‰∏≠ÁöÑÊó∂Èó¥ÊÆµÊåâÈíÆ
        document.querySelectorAll('#modal-tab-buttons .tab-btn').forEach(function(btn) {
            btn.classList.toggle('selected', btn.dataset.tab === tab);
        });
        updateCounts();  // Êõ¥Êñ∞Ë±°ÈôêËÆ°Êï∞Ôºà‰æùËµñ currentTabÔºâ
        renderItems();
    }

    // Ë±°ÈôêÊäòÂè†ÂäüËÉΩ
    function toggleQuadrant(header) {
        var quadrant = header.closest('.quadrant');
        quadrant.classList.toggle('collapsed');
        saveQuadrantState();
    }

    function saveQuadrantState() {
        var states = {};
        document.querySelectorAll('.quadrant').forEach(function(q) {
            states[q.dataset.quadrant] = q.classList.contains('collapsed');
        });
        localStorage.setItem('quadrantStates', JSON.stringify(states));
    }

    function loadQuadrantState() {
        var saved = localStorage.getItem('quadrantStates');
        if (!saved) return; // ‰ΩøÁî® HTML ÈªòËÆ§Áä∂ÊÄÅ
        var states = JSON.parse(saved);
        document.querySelectorAll('.quadrant').forEach(function(q) {
            var key = q.dataset.quadrant;
            if (states[key] !== undefined) {
                q.classList.toggle('collapsed', states[key]);
            }
        });
    }

    function loadItems() {
        fetch('/api/todos')
            .then(response => response.json())
            .then(data => {
                allItems = data.items || [];
                updateCounts();
                renderItems();
            });
    }

    function updateCounts() {
        var counts = { today: 0, week: 0, month: 0 };
        var qcounts = {
            'important-urgent': 0,
            'important-not-urgent': 0,
            'not-important-urgent': 0,
            'not-important-not-urgent': 0
        };
        allItems.forEach(function(item) {
            if (!item.completed && !item.deleted) {
                counts[item.tab] = (counts[item.tab] || 0) + 1;
                // ÂΩìÂâç tab ÁöÑË±°ÈôêËÆ°Êï∞
                if (item.tab === currentTab) {
                    qcounts[item.quadrant] = (qcounts[item.quadrant] || 0) + 1;
                }
            }
        });
        document.getElementById('count-today').textContent = counts.today;
        document.getElementById('count-week').textContent = counts.week;
        document.getElementById('count-month').textContent = counts.month;
        // Êõ¥Êñ∞Ë±°ÈôêËÆ°Êï∞
        Object.keys(qcounts).forEach(function(q) {
            var el = document.getElementById('qcount-' + q);
            if (el) el.textContent = '(' + qcounts[q] + ')';
        });
    }

    function renderItems() {
        var quadrants = ['important-urgent', 'important-not-urgent', 'not-important-urgent', 'not-important-not-urgent'];

        quadrants.forEach(function(q) {
            document.getElementById('items-' + q).innerHTML = '';
        });

        var completedHtml = '';
        var deletedHtml = '';

        // Ê∏≤ÊüìÊú™ÂÆåÊàê‰ªªÂä°ÔºàÊåâ tab ËøáÊª§ÔºåÊéíÈô§Â∑≤Âà†Èô§Ôºâ
        allItems.forEach(function(item) {
            if (item.deleted) return;
            if (item.tab !== currentTab) return;
            if (item.completed) return;

            var container = document.getElementById('items-' + item.quadrant);
            if (container) {
                container.innerHTML += createItemHtml(item);
            }
        });

        // Ê∏≤ÊüìÂ∑≤ÂÆåÊàê‰ªªÂä°Ôºà‰∏çËøáÊª§ tabÔºåÊéíÈô§Â∑≤Âà†Èô§Ôºâ
        allItems.forEach(function(item) {
            if (item.deleted) return;
            if (item.completed) {
                completedHtml += createCompletedItemHtml(item);
            }
        });

        // Ê∏≤ÊüìÂ∑≤Âà†Èô§‰ªªÂä°
        allItems.forEach(function(item) {
            if (item.deleted) {
                deletedHtml += createDeletedItemHtml(item);
            }
        });

        document.getElementById('completed-list').innerHTML = completedHtml || '<div class="empty-hint">ÊöÇÊó†Â∑≤ÂÆåÊàê‰ªªÂä°</div>';
        document.getElementById('deleted-list').innerHTML = deletedHtml || '<div class="empty-hint">ÊöÇÊó†Â∑≤Âà†Èô§‰ªªÂä°</div>';

        // Re-attach touch handlers for mobile
        attachTouchHandlers();
        // Re-attach tooltip handlers
        attachTooltipHandlers();
        // Ê£ÄÊü•ÂêÑË±°Èôê‰ªªÂä°Êï∞ÈáèÔºåÂÜ≥ÂÆöÊòØÂê¶ÈúÄË¶ÅÊªöÂä®
        updateQuadrantScroll();
        // Êõ¥Êñ∞ÊåâÈíÆÂä®Êïà
        updateButtonAnimations();
    }

    // Ê£ÄÊü•Ë±°Èôê‰ªªÂä°Êï∞ÈáèÔºåË∂ÖËøá15‰∏™ÂàôÊ∑ªÂä†ÊªöÂä®
    function updateQuadrantScroll() {
        var quadrants = ['important-urgent', 'important-not-urgent', 'not-important-urgent', 'not-important-not-urgent'];
        quadrants.forEach(function(q) {
            var container = document.getElementById('items-' + q);
            if (container) {
                var taskCount = container.querySelectorAll('.task-item').length;
                if (taskCount > 15) {
                    container.classList.add('has-scroll');
                } else {
                    container.classList.remove('has-scroll');
                }
            }
        });
    }

    function createItemHtml(item) {
        var progress = item.progress || 0;
        // ËøõÂ∫¶ÂúÜÁéØÔºàÊòæÁ§∫ËøõÂ∫¶ÁôæÂàÜÊØîÔºåÁÇπÂáªÂèØÊõ¥Êñ∞Ôºâ
        var progressRing = '<div class="progress-ring" style="--progress:' + progress + '" onclick="event.stopPropagation(); showProgressPopup(\'' + item.id + '\', this)" onmousedown="event.stopPropagation()" title="ÁÇπÂáªÊõ¥Êñ∞ËøõÂ∫¶">' +
            '<span class="progress-ring-text">' + progress + '</span>' +
        '</div>';

        // Áõ∏ÂÖ≥‰∫∫ÊòæÁ§∫
        var assigneeHtml = item.assignee
            ? '<span class="task-assignee" title="' + escapeHtml(item.assignee) + '">' + escapeHtml(item.assignee) + '</span>'
            : '';

        return '<div class="task-item" data-id="' + item.id + '" onmousedown="startCustomDrag(event)">' +
            '<div class="drag-handle">‚ãÆ‚ãÆ</div>' +
            '<div class="task-checkbox" onclick="event.stopPropagation(); toggleComplete(\'' + item.id + '\')" onmousedown="event.stopPropagation()"></div>' +
            progressRing +
            '<div class="task-content" onclick="showTaskCard(\'' + item.id + '\', this.closest(\'.task-item\'))">' +
                '<div class="task-text">' + escapeHtml(item.text) + '</div>' +
            '</div>' +
            assigneeHtml +
            '<button class="task-delete" onmousedown="event.stopPropagation()" onclick="event.stopPropagation(); deleteTask(\'' + item.id + '\')" title="Âà†Èô§">&times;</button>' +
        '</div>';
    }

    function getCompletionStatus(item) {
        if (!item.due_date || !item.completed_at) return '';
        var due = new Date(item.due_date);
        due.setHours(23, 59, 59); // Êà™Ê≠¢Êó•ÊúüÁÆóÂà∞ÂΩìÂ§©ÁªìÊùü
        var completed = new Date(item.completed_at);
        var diff = Math.floor((due - completed) / (1000 * 60 * 60 * 24));
        if (diff > 0) return '<span class="status-early">ÊèêÂâç' + diff + 'Â§©</span>';
        if (diff < 0) return '<span class="status-late">Ë∂ÖÊúü' + Math.abs(diff) + 'Â§©</span>';
        return '<span class="status-ontime">ÊåâÊó∂</span>';
    }

    function createCompletedItemHtml(item) {
        var assignee = item.assignee ? escapeHtml(item.assignee) : '--';
        var status = getCompletionStatus(item);
        return '<div class="task-item completed" data-id="' + item.id + '" onclick="showTaskCard(\'' + item.id + '\')">' +
            '<div class="task-checkbox checked" onclick="event.stopPropagation(); toggleComplete(\'' + item.id + '\')">‚úì</div>' +
            '<div class="completed-task-name">' + escapeHtml(item.text) + '</div>' +
            '<div class="completed-task-assignee">' + assignee + '</div>' +
            '<div class="completed-task-status">' + status + '</div>' +
        '</div>';
    }

    function createDeletedItemHtml(item) {
        return '<div class="task-item deleted" data-id="' + item.id + '">' +
            '<div class="deleted-task-name">' + escapeHtml(item.text) + '</div>' +
            '<div class="deleted-task-actions">' +
                '<button class="btn-restore" onclick="restoreTask(\'' + item.id + '\')" title="ÊÅ¢Â§ç">‚Ü©</button>' +
                '<button class="btn-permanent-delete" onclick="permanentDeleteTask(\'' + item.id + '\')" title="Ê∞∏‰πÖÂà†Èô§">√ó</button>' +
            '</div>' +
        '</div>';
    }

    function escapeHtml(str) {
        if (!str) return '';
        return str.replace(/&/g, '&amp;')
                  .replace(/</g, '&lt;')
                  .replace(/>/g, '&gt;')
                  .replace(/"/g, '&quot;');
    }

    function formatDate(isoString) {
        var date = new Date(isoString);
        var m = (date.getMonth() + 1).toString().padStart(2, '0');
        var d = date.getDate().toString().padStart(2, '0');
        var h = date.getHours().toString().padStart(2, '0');
        var min = date.getMinutes().toString().padStart(2, '0');
        return m + '-' + d + ' ' + h + ':' + min;
    }

    // Custom Drag and Drop (more reliable than HTML5 drag-drop)
    var isDragging = false;
    var dragClone = null;
    var dragItemId = null;
    var dragStartX = 0;
    var dragStartY = 0;
    var dragThreshold = 5; // pixels to move before starting drag

    function startCustomDrag(e) {
        // Only left mouse button
        if (e.button !== 0) return;

        var taskItem = e.target.closest('.task-item');
        if (!taskItem || taskItem.classList.contains('completed')) return;

        dragItemId = taskItem.dataset.id;
        draggedItem = taskItem;
        dragStartX = e.clientX;
        dragStartY = e.clientY;

        // Add listeners for drag
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);

        e.preventDefault();
    }

    function onMouseMove(e) {
        var dx = e.clientX - dragStartX;
        var dy = e.clientY - dragStartY;

        // Check if we've moved enough to start dragging
        if (!isDragging && (Math.abs(dx) > dragThreshold || Math.abs(dy) > dragThreshold)) {
            isDragging = true;
            startDragVisual(e);
        }

        if (isDragging && dragClone) {
            // Move the clone
            dragClone.style.left = e.clientX + 'px';
            dragClone.style.top = e.clientY + 'px';

            // Highlight quadrant under cursor
            highlightQuadrantUnderCursor(e.clientX, e.clientY);
        }
    }

    function startDragVisual(e) {
        if (!draggedItem) return;

        // Create visual clone
        dragClone = document.createElement('div');
        dragClone.className = 'drag-clone';
        dragClone.textContent = draggedItem.querySelector('.task-text').textContent;
        dragClone.style.left = e.clientX + 'px';
        dragClone.style.top = e.clientY + 'px';
        document.body.appendChild(dragClone);

        // Mark original as dragging
        draggedItem.classList.add('dragging');

        // Show tab drop zones
        document.getElementById('tab-drop-zones').style.display = 'flex';
        document.querySelectorAll('.tab-drop-zone').forEach(function(zone) {
            zone.style.display = zone.dataset.targetTab === currentTab ? 'none' : 'flex';
        });
    }

    function highlightQuadrantUnderCursor(x, y) {
        // Remove all highlights first
        document.querySelectorAll('.quadrant.drag-over').forEach(function(q) {
            q.classList.remove('drag-over');
        });
        document.querySelectorAll('.drop-quadrant.drag-over').forEach(function(q) {
            q.classList.remove('drag-over');
        });
        document.querySelectorAll('.tab-drop-zone.drag-over').forEach(function(q) {
            q.classList.remove('drag-over');
        });

        var tabDropZones = document.getElementById('tab-drop-zones');
        var matrix = document.querySelector('.eisenhower-matrix');
        var isOverDropZone = false;

        // Find element under cursor
        var elements = document.elementsFromPoint(x, y);
        for (var i = 0; i < elements.length; i++) {
            // Check for drop-quadrant first (most specific)
            var dropQuadrant = elements[i].closest('.drop-quadrant');
            if (dropQuadrant) {
                dropQuadrant.classList.add('drag-over');
                dropQuadrant.closest('.tab-drop-zone').classList.add('drag-over');
                isOverDropZone = true;
                break;
            }

            // Check for tab-drop-zone
            var dropZone = elements[i].closest('.tab-drop-zone');
            if (dropZone) {
                dropZone.classList.add('drag-over');
                isOverDropZone = true;
                break;
            }

            // Check for matrix quadrant
            var quadrant = elements[i].closest('.quadrant');
            if (quadrant) {
                quadrant.classList.add('drag-over');
                break;
            }
        }

        // Add/remove focus effect classes
        if (isOverDropZone) {
            tabDropZones.classList.add('has-focus');
            matrix.classList.add('dimmed');
        } else {
            tabDropZones.classList.remove('has-focus');
            matrix.classList.remove('dimmed');
        }
    }

    function onMouseUp(e) {
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);

        if (isDragging) {
            // Find target
            var elements = document.elementsFromPoint(e.clientX, e.clientY);
            var targetQuadrant = null;
            var targetTab = null;

            for (var i = 0; i < elements.length; i++) {
                // Check for drop-quadrant first (cross-tab with specific quadrant)
                var dq = elements[i].closest('.drop-quadrant');
                if (dq) {
                    targetTab = dq.dataset.targetTab;
                    targetQuadrant = dq.dataset.targetQuadrant;
                    break;
                }

                // Check for tab-drop-zone (cross-tab, keep same quadrant)
                var tz = elements[i].closest('.tab-drop-zone');
                if (tz && !elements[i].closest('.drop-quadrant')) {
                    targetTab = tz.dataset.targetTab;
                    break;
                }

                // Check for matrix quadrant (same tab)
                var q = elements[i].closest('.quadrant');
                if (q) {
                    targetQuadrant = q.dataset.quadrant;
                    break;
                }
            }

            if (targetTab && targetQuadrant) {
                // Move to different tab AND different quadrant
                moveToTabAndQuadrant(dragItemId, targetTab, targetQuadrant);
            } else if (targetTab) {
                // Move to different tab, keep same quadrant
                moveToTab(dragItemId, targetTab);
            } else if (targetQuadrant) {
                // Move to different quadrant, same tab
                moveToQuadrant(dragItemId, targetQuadrant);
            }

            // Cleanup
            endDrag();
        }

        isDragging = false;
        dragItemId = null;
        draggedItem = null;
    }

    function endDrag() {
        // Remove clone
        if (dragClone) {
            dragClone.remove();
            dragClone = null;
        }

        // Remove dragging class
        document.querySelectorAll('.task-item.dragging').forEach(function(item) {
            item.classList.remove('dragging');
        });

        // Hide drop zones and remove focus effects
        var tabDropZones = document.getElementById('tab-drop-zones');
        tabDropZones.style.display = 'none';
        tabDropZones.classList.remove('has-focus');

        // Remove matrix dimming
        var matrix = document.querySelector('.eisenhower-matrix');
        if (matrix) matrix.classList.remove('dimmed');

        // Remove all highlights
        document.querySelectorAll('.quadrant.drag-over').forEach(function(q) {
            q.classList.remove('drag-over');
        });
        document.querySelectorAll('.drop-quadrant.drag-over').forEach(function(q) {
            q.classList.remove('drag-over');
        });
        document.querySelectorAll('.tab-drop-zone.drag-over').forEach(function(q) {
            q.classList.remove('drag-over');
        });
    }

    function moveToQuadrant(itemId, newQuadrant) {
        var item = allItems.find(function(i) { return i.id === itemId; });
        if (!item || item.quadrant === newQuadrant) return;

        fetch('/api/todos/' + itemId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ quadrant: newQuadrant })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allItems = allItems.map(function(i) {
                    if (i.id === itemId) return data.item || Object.assign(i, {quadrant: newQuadrant});
                    return i;
                });
                renderItems();
                showToast('Â∑≤ÁßªÂä®Âà∞' + getQuadrantName(newQuadrant), 'success');
            }
        });
    }

    function moveToTab(itemId, newTab) {
        if (newTab === currentTab) return;

        fetch('/api/todos/' + itemId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tab: newTab })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allItems = allItems.map(function(i) {
                    if (i.id === itemId) return data.item || Object.assign(i, {tab: newTab});
                    return i;
                });
                updateCounts();
                renderItems();
                showToast('Â∑≤ÁßªÂä®Âà∞ ' + getTabName(newTab), 'success');
            }
        });
    }

    function moveToTabAndQuadrant(itemId, newTab, newQuadrant) {
        var item = allItems.find(function(i) { return i.id === itemId; });
        if (!item) return;

        // Check if anything actually changes
        if (item.tab === newTab && item.quadrant === newQuadrant) return;

        fetch('/api/todos/' + itemId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tab: newTab, quadrant: newQuadrant })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allItems = allItems.map(function(i) {
                    if (i.id === itemId) return data.item || Object.assign(i, {tab: newTab, quadrant: newQuadrant});
                    return i;
                });
                updateCounts();
                renderItems();
                showToast('Â∑≤ÁßªÂä®Âà∞ ' + getTabName(newTab) + ' - ' + getQuadrantName(newQuadrant), 'success');
            }
        });
    }

    function getQuadrantName(q) {
        var names = {
            'important-urgent': '‰ºòÂÖàÂ§ÑÁêÜ',
            'important-not-urgent': 'Â∞±Á≠â‰Ω†ÁøªÁâåÂ≠ê‰∫Ü',
            'not-important-urgent': 'ÂæÖÂàÜÁ±ª',
            'not-important-not-urgent': 'Áü≠Âπ≥Âø´'
        };
        return names[q] || q;
    }

    function dropToTab(e, targetTab) {
        e.preventDefault();
        var itemId = e.dataTransfer.getData('text/plain');

        if (!itemId || targetTab === currentTab) return;

        fetch('/api/todos/' + itemId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tab: targetTab })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allItems = allItems.map(function(item) {
                    if (item.id === itemId) {
                        item.tab = targetTab;
                    }
                    return item;
                });
                updateCounts();
                renderItems();
                showToast('Â∑≤ÁßªÂä®Âà∞ ' + getTabName(targetTab), 'success');
            }
        });
    }

    function getTabName(tab) {
        var names = { today: 'Today', week: 'This Week', month: 'Next 30 Days' };
        return names[tab] || tab;
    }

    // Task Actions - ËÆæÁΩÆÂÆåÊàêÂ∫¶ËøõÂ∫¶Êù°
    function toggleComplete(itemId) {
        var item = allItems.find(function(i) { return i.id === itemId; });
        if (!item) return;

        // Â¶ÇÊûúÂ∑≤ÂÆåÊàêÔºåÁõ¥Êé•ÊÅ¢Â§ç‰∏∫Êú™ÂÆåÊàê
        if (item.completed) {
            fetch('/api/todos/' + itemId, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ completed: false, progress: 0 })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allItems = allItems.map(function(i) {
                        return i.id === itemId ? data.item : i;
                    });
                    updateCounts();
                    renderItems();
                    showToast('Â∑≤ÊÅ¢Â§ç', 'success');
                }
            });
            return;
        }

        // ÊòæÁ§∫ËÆæÁΩÆÂÆåÊàêÂ∫¶ÂºπÁ™ó
        showProgressDialog(item);
    }

    // ÈÄöËøá ID ÊòæÁ§∫ËøõÂ∫¶ÂºπÁ™óÔºà‰æõÂúÜÁéØÁÇπÂáªË∞ÉÁî®Ôºâ
    function showProgressPopup(itemId, element) {
        var item = allItems.find(function(i) { return i.id === itemId; });
        if (item) {
            showProgressDialog(item);
        }
    }

    // ÊòæÁ§∫ÂÆåÊàêÂ∫¶ËøõÂ∫¶Êù°ÂºπÁ™ó
    function showProgressDialog(item) {
        var currentProgress = item.progress || 0;

        var overlay = document.createElement('div');
        overlay.className = 'progress-dialog-overlay';
        overlay.innerHTML =
            '<div class="progress-dialog">' +
                '<div class="progress-dialog-title">ËÆæÁΩÆÂÆåÊàêÂ∫¶</div>' +
                '<div class="progress-dialog-task">' + escapeHtml(item.text) + '</div>' +
                '<div class="progress-slider-container">' +
                    '<input type="range" class="progress-slider" id="progress-slider" min="0" max="100" value="' + currentProgress + '" style="--val:' + currentProgress + '%">' +
                    '<div class="progress-value" id="progress-value">' + currentProgress + '%</div>' +
                '</div>' +
                '<div class="progress-dialog-buttons">' +
                    '<button class="progress-btn cancel" id="progress-cancel">ÂèñÊ∂à</button>' +
                    '<button class="progress-btn confirm" id="progress-confirm">Á°ÆÂÆö</button>' +
                '</div>' +
            '</div>';

        document.body.appendChild(overlay);

        var slider = document.getElementById('progress-slider');
        var valueDisplay = document.getElementById('progress-value');
        var confirmBtn = document.getElementById('progress-confirm');
        var cancelBtn = document.getElementById('progress-cancel');

        // ËøõÂ∫¶Êù°ÊãñÊãΩÁä∂ÊÄÅ
        var lastSliderValue = currentProgress;
        var sliderVelocity = 0;

        // Êõ¥Êñ∞ËøõÂ∫¶ÊòæÁ§∫
        slider.addEventListener('input', function() {
            var val = parseInt(slider.value);
            valueDisplay.textContent = val + '%';
            slider.style.setProperty('--val', val + '%');

            // ËÆ°ÁÆóÊãñÊãΩÈÄüÂ∫¶
            sliderVelocity = Math.abs(val - lastSliderValue);
            lastSliderValue = val;

            // Living Line ËÅîÂä® - ËÆ°ÁÆóÊªëÂùóÂú®Â±èÂπï‰∏äÁöÑ‰ΩçÁΩÆ
            if (window.syncLineWithProgress) {
                var sliderRect = slider.getBoundingClientRect();
                var sliderX = sliderRect.left + (val / 100) * sliderRect.width;
                window.syncLineWithProgress(sliderX, sliderVelocity);
            }

            if (val >= 100) {
                valueDisplay.classList.add('complete');
                confirmBtn.textContent = 'Á°ÆÂÆöÂÆåÊàê';
                confirmBtn.classList.add('complete');
            } else {
                valueDisplay.classList.remove('complete');
                confirmBtn.textContent = 'Á°ÆÂÆö';
                confirmBtn.classList.remove('complete');
            }
        });

        // ÊùæÊâãÊó∂ÈáäÊîæ Living Line
        slider.addEventListener('mouseup', function() {
            if (window.releaseLineProgress) {
                window.releaseLineProgress();
            }
        });
        slider.addEventListener('touchend', function() {
            if (window.releaseLineProgress) {
                window.releaseLineProgress();
            }
        });

        // ÂèñÊ∂àÊåâÈíÆ
        cancelBtn.addEventListener('click', function() {
            document.body.removeChild(overlay);
        });

        // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
        overlay.addEventListener('click', function(e) {
            if (e.target === overlay) {
                document.body.removeChild(overlay);
            }
        });

        // Á°ÆÂÆöÊåâÈíÆ
        confirmBtn.addEventListener('click', function() {
            var newProgress = parseInt(slider.value);

            // Â¶ÇÊûúÊòØ100%Ôºå‰∫åÊ¨°Á°ÆËÆ§
            if (newProgress >= 100) {
                document.body.removeChild(overlay);
                window.AppUtils.showConfirm(
                    'Á°ÆÂÆöË¶ÅÂ∞ÜÊ≠§‰ªªÂä°Ê†áËÆ∞‰∏∫Â∑≤ÂÆåÊàêÂêóÔºü\nÂÆåÊàêÂêé‰ªªÂä°Â∞ÜÁßªËá≥Â∑≤ÂÆåÊàêÂàóË°®„ÄÇ',
                    function() {
                        saveProgress(item.id, 100, true);
                    },
                    { confirmText: 'Á°ÆÂÆöÂÆåÊàê' }
                );
            } else {
                saveProgress(item.id, newProgress, false);
                document.body.removeChild(overlay);
            }
        });
    }

    // ‰øùÂ≠òËøõÂ∫¶
    function saveProgress(itemId, progress, completed) {
        fetch('/api/todos/' + itemId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ progress: progress, completed: completed })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allItems = allItems.map(function(i) {
                    return i.id === itemId ? data.item : i;
                });
                updateCounts();
                renderItems();
                showToast(completed ? 'Â∑≤ÂÆåÊàê' : 'ËøõÂ∫¶Â∑≤Êõ¥Êñ∞', 'success');
                // Ëß¶Âèë Living Line ÊàêÂäüËÑâÂÜ≤
                if (window.triggerLinePulse) {
                    window.triggerLinePulse('success');
                }
            } else {
                // Ëß¶Âèë Living Line Â§±Ë¥•ËÑâÂÜ≤
                if (window.triggerLinePulse) {
                    window.triggerLinePulse('error');
                }
            }
        })
        .catch(function() {
            if (window.triggerLinePulse) {
                window.triggerLinePulse('error');
            }
        });
    }

    function deleteTask(itemId) {
        window.AppUtils.showConfirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰ªªÂä°ÂêóÔºü', function() {
            fetch('/api/todos/' + itemId, { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // ËΩØÂà†Èô§ÔºöÊõ¥Êñ∞Êú¨Âú∞Áä∂ÊÄÅ
                        var item = allItems.find(function(i) { return i.id === itemId; });
                        if (item) {
                            item.deleted = true;
                            item.deleted_at = new Date().toISOString();
                        }
                        updateCounts();
                        renderItems();
                        showToast('Â∑≤ÁßªÂÖ•ÂõûÊî∂Á´ô', 'success');
                    }
                });
        }, { confirmText: 'Âà†Èô§', danger: true });
    }

    function restoreTask(itemId) {
        fetch('/api/todos/' + itemId + '/restore', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    var item = allItems.find(function(i) { return i.id === itemId; });
                    if (item) {
                        item.deleted = false;
                        delete item.deleted_at;
                    }
                    updateCounts();
                    renderItems();
                    showToast('Â∑≤ÊÅ¢Â§ç', 'success');
                }
            });
    }

    function permanentDeleteTask(itemId) {
        window.AppUtils.showConfirm('Ê∞∏‰πÖÂà†Èô§ÂêéÊó†Ê≥ïÊÅ¢Â§çÔºåÁ°ÆÂÆöÂêóÔºü', function() {
            fetch('/api/todos/' + itemId + '/permanent', { method: 'DELETE' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        allItems = allItems.filter(function(i) { return i.id !== itemId; });
                        renderItems();
                        showToast('Â∑≤Ê∞∏‰πÖÂà†Èô§', 'success');
                    }
                });
        }, { confirmText: 'Ê∞∏‰πÖÂà†Èô§', danger: true });
    }

    function editTask(itemId) {
        var item = allItems.find(function(i) { return i.id === itemId; });
        if (!item) return;

        var taskElement = document.querySelector('.task-item[data-id="' + itemId + '"]');
        if (!taskElement) return;

        var textElement = taskElement.querySelector('.task-text');
        if (!textElement || textElement.classList.contains('editing')) return;

        var originalText = item.text;

        // ÂàõÂª∫ÁºñËæëËæìÂÖ•Ê°Ü
        var editInput = document.createElement('input');
        editInput.type = 'text';
        editInput.className = 'task-edit-input';
        editInput.value = originalText;

        // ÊõøÊç¢ÊñáÊú¨‰∏∫ËæìÂÖ•Ê°Ü
        textElement.classList.add('editing');
        textElement.innerHTML = '';
        textElement.appendChild(editInput);
        editInput.focus();
        editInput.select();

        // ‰øùÂ≠òÂáΩÊï∞
        function saveEdit() {
            var newText = editInput.value.trim();
            if (!newText || newText === originalText) {
                cancelEdit();
                return;
            }

            fetch('/api/todos/' + itemId, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: newText })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allItems = allItems.map(function(i) {
                        if (i.id === itemId) {
                            i.text = newText;
                        }
                        return i;
                    });
                    renderItems();
                    showToast('Â∑≤Êõ¥Êñ∞', 'success');
                } else {
                    cancelEdit();
                    showToast('Êõ¥Êñ∞Â§±Ë¥•', 'error');
                }
            })
            .catch(function() {
                cancelEdit();
                showToast('Êõ¥Êñ∞Â§±Ë¥•', 'error');
            });
        }

        // ÂèñÊ∂àÁºñËæëÂáΩÊï∞
        function cancelEdit() {
            textElement.classList.remove('editing');
            textElement.innerHTML = escapeHtml(originalText);
        }

        // ‰∫ã‰ª∂ÁõëÂê¨
        editInput.addEventListener('blur', saveEdit);
        editInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                editInput.blur();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                editInput.removeEventListener('blur', saveEdit);
                cancelEdit();
            }
        });
    }

    // Modal
    // ========== Áªü‰∏Ä‰ªªÂä°ÂºπÁ™ó ==========
    var modalMode = 'view';  // 'view', 'edit', 'create'
    var modalTaskId = null;
    var modalTaskItem = null;

    function showAddModal() {
        openTaskModal('create', null, currentTab, 'important-urgent');
    }

    function showAddModalForQuadrant(quadrant) {
        openTaskModal('create', null, currentTab, quadrant);
    }

    function showTaskCard(taskId, element) {
        var item = allItems.find(function(i) { return i.id === taskId; });
        if (!item) return;
        openTaskModal('view', item);
    }

    function openTaskModal(mode, item, tab, quadrant) {
        modalMode = mode;
        modalTaskId = item ? item.id : null;
        modalTaskItem = item;

        var overlay = document.getElementById('task-modal-overlay');
        var titleInput = document.getElementById('modal-title');
        var contentInput = document.getElementById('modal-content');
        var progressInput = document.getElementById('modal-progress');
        var progressValue = document.getElementById('modal-progress-value');
        var dueDateInput = document.getElementById('modal-due-date');
        var assigneeInput = document.getElementById('modal-assignee');

        // ÈáçÁΩÆ textarea Â∞∫ÂØ∏
        contentInput.style.height = '';

        // Â°´ÂÖÖÊï∞ÊçÆ
        if (item) {
            titleInput.value = item.text || '';
            contentInput.value = item.content || '';
            progressInput.value = item.progress || 0;
            progressValue.textContent = (item.progress || 0) + '%';
            progressInput.style.setProperty('--val', (item.progress || 0) + '%');
            dueDateInput.value = item.due_date || '';
            assigneeInput.value = item.assignee || '';
            setModalTab(item.tab || 'today');
            setModalQuadrant(item.quadrant || 'important-urgent');
        } else {
            titleInput.value = '';
            contentInput.value = '';
            progressInput.value = 0;
            progressValue.textContent = '0%';
            progressInput.style.setProperty('--val', '0%');
            dueDateInput.value = '';
            assigneeInput.value = '';
            setModalTab(tab || currentTab);
            setModalQuadrant(quadrant || 'important-urgent');
        }

        // Â°´ÂÖÖÊó∂Èó¥‰ø°ÊÅØ
        var createdAtEl = document.getElementById('modal-created-at');
        var completedAtEl = document.getElementById('modal-completed-at');
        if (item && item.created_at) {
            createdAtEl.querySelector('.meta-text').textContent = 'ÂàõÂª∫‰∫é ' + formatDateTime(item.created_at);
            createdAtEl.style.display = 'flex';
        } else {
            createdAtEl.style.display = mode === 'create' ? 'none' : 'flex';
            createdAtEl.querySelector('.meta-text').textContent = 'ÂàõÂª∫‰∫é --';
        }
        if (item && item.completed && item.completed_at) {
            completedAtEl.querySelector('.meta-text').textContent = 'ÂÆåÊàê‰∫é ' + formatDateTime(item.completed_at);
            completedAtEl.style.display = 'flex';
        } else {
            completedAtEl.style.display = 'none';
        }

        // Â°´ÂÖÖÂèòÊõ¥ËÆ∞ÂΩï
        var changelogList = document.getElementById('modal-changelog');
        var changelog = (item && item.changelog) || [];
        if (changelog.length > 0) {
            var html = '';
            changelog.slice(-10).reverse().forEach(function(log) {
                html += '<div class="changelog-item">' +
                    '<span class="changelog-time">' + formatShortTime(log.time) + '</span>' +
                    '<span class="changelog-text">' + escapeHtml(log.label) + '</span>' +
                '</div>';
            });
            changelogList.innerHTML = html;
        } else {
            changelogList.innerHTML = '<div class="changelog-empty">ÊöÇÊó†ÂèòÊõ¥ËÆ∞ÂΩï</div>';
        }
        // ÈáçÁΩÆÂèòÊõ¥ËÆ∞ÂΩïÊäòÂè†Áä∂ÊÄÅÔºà‰ΩøÁî®classÊéßÂà∂ÔºåÊîØÊåÅËøáÊ∏°Âä®ÁîªÔºâ
        changelogList.classList.remove('expanded');
        document.getElementById('changelog-toggle').classList.remove('expanded');

        // Êñ∞Âª∫Ê®°ÂºèÈöêËóèÊó∂Èó¥‰ø°ÊÅØÂíåÂèòÊõ¥ËÆ∞ÂΩï
        document.getElementById('modal-meta-section').style.display = mode === 'create' ? 'none' : 'block';
        document.getElementById('modal-changelog-section').style.display = mode === 'create' ? 'none' : 'block';

        // ËÆæÁΩÆÊ®°Âºè
        setModalMode(mode);

        // ÊòæÁ§∫ÂºπÁ™ó
        overlay.style.display = 'flex';

        // ËÅöÁÑ¶
        if (mode === 'create' || mode === 'edit') {
            setTimeout(function() { titleInput.focus(); }, 100);
        }
    }

    function formatDateTime(isoString) {
        if (!isoString) return '--';
        var date = new Date(isoString);
        var now = new Date();
        var y = date.getFullYear();
        var m = String(date.getMonth() + 1).padStart(2, '0');
        var d = String(date.getDate()).padStart(2, '0');
        var h = String(date.getHours()).padStart(2, '0');
        var min = String(date.getMinutes()).padStart(2, '0');
        if (y === now.getFullYear()) {
            return m + '-' + d + ' ' + h + ':' + min;
        }
        return y + '-' + m + '-' + d + ' ' + h + ':' + min;
    }

    function formatShortTime(isoString) {
        if (!isoString) return '--';
        var date = new Date(isoString);
        var m = String(date.getMonth() + 1).padStart(2, '0');
        var d = String(date.getDate()).padStart(2, '0');
        var h = String(date.getHours()).padStart(2, '0');
        var min = String(date.getMinutes()).padStart(2, '0');
        return m + '-' + d + ' ' + h + ':' + min;
    }

    function toggleChangelog() {
        var btn = document.getElementById('changelog-toggle');
        var list = document.getElementById('modal-changelog');
        btn.classList.toggle('expanded');
        list.classList.toggle('expanded');
    }

    function setModalMode(mode) {
        modalMode = mode;
        var isEditable = (mode === 'edit' || mode === 'create');

        // Â≠óÊÆµÂèØÁºñËæëÊÄß
        document.getElementById('modal-title').readOnly = !isEditable;
        document.getElementById('modal-content').readOnly = !isEditable;
        document.getElementById('modal-progress').disabled = !isEditable;
        document.getElementById('modal-due-date').readOnly = !isEditable;
        document.getElementById('modal-assignee').readOnly = !isEditable;

        // Êó∂Èó¥ÊÆµÊåâÈíÆ
        document.querySelectorAll('#modal-tab-buttons .tab-btn').forEach(function(btn) {
            btn.disabled = !isEditable;
        });

        // Ë±°ÈôêÈÄâÊã©Âô®
        document.querySelectorAll('.q-option').forEach(function(opt) {
            if (isEditable) {
                opt.classList.remove('disabled');
                opt.style.pointerEvents = 'auto';
            } else {
                opt.classList.add('disabled');
                opt.style.pointerEvents = 'none';
            }
        });

        // Ê†áÈ¢òÊ†èÁºñËæëÊåâÈíÆÔºà‰ªÖÊü•ÁúãÊ®°ÂºèÊòæÁ§∫Ôºâ
        document.getElementById('header-edit-btn').style.display = (mode === 'view') ? 'inline-block' : 'none';

        // Â∫ïÈÉ®ÊåâÈíÆÔºàÁºñËæë/Êñ∞Âª∫Ê®°ÂºèÊòæÁ§∫Ôºâ
        document.getElementById('modal-footer-edit').style.display = (mode !== 'view') ? 'flex' : 'none';

        // ‰øùÂ≠òÊåâÈíÆÊñáÂ≠ó
        var saveBtn = document.getElementById('modal-save-btn');
        saveBtn.textContent = (mode === 'create') ? 'ÂàõÂª∫' : '‰øùÂ≠ò';
    }

    function setModalQuadrant(quadrant) {
        document.querySelectorAll('.q-option').forEach(function(opt) {
            opt.classList.remove('selected');
            if (opt.dataset.q === quadrant) {
                opt.classList.add('selected');
                opt.querySelector('input').checked = true;
            }
        });
    }

    function setModalTab(tab) {
        document.querySelectorAll('#modal-tab-buttons .tab-btn').forEach(function(btn) {
            btn.classList.toggle('selected', btn.dataset.tab === tab);
        });
    }

    function getModalTab() {
        var selectedBtn = document.querySelector('#modal-tab-buttons .tab-btn.selected');
        return selectedBtn ? selectedBtn.dataset.tab : 'today';
    }

    function switchToEditMode() {
        setModalMode('edit');
        document.getElementById('modal-title').focus();
    }

    // ÁÇπÂáª content Âå∫ÂüüÁõ¥Êé•ËøõÂÖ•ÁºñËæëÊ®°Âºè
    function onContentClick() {
        if (modalMode === 'view') {
            setModalMode('edit');
            document.getElementById('modal-content').focus();
        }
    }

    function closeTaskModal() {
        document.getElementById('task-modal-overlay').style.display = 'none';
        modalMode = 'view';
        modalTaskId = null;
        modalTaskItem = null;
    }

    function saveTask() {
        var title = document.getElementById('modal-title').value.trim();
        var content = document.getElementById('modal-content').value.trim();
        var progress = parseInt(document.getElementById('modal-progress').value) || 0;
        var dueDate = document.getElementById('modal-due-date').value || null;
        var assignee = document.getElementById('modal-assignee').value.trim();
        var tab = getModalTab();
        var quadrant = document.querySelector('.q-option.selected input').value;

        if (!title) {
            showToast('ËØ∑ËæìÂÖ•‰ªªÂä°Ê†áÈ¢ò', 'error');
            return;
        }

        var data = {
            text: title,
            content: content,
            progress: progress,
            due_date: dueDate,
            assignee: assignee,
            tab: tab,
            quadrant: quadrant
        };

        if (modalMode === 'create') {
            // ÂàõÂª∫Êñ∞‰ªªÂä°
            fetch('/api/todos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    allItems.push(result.item);
                    updateCounts();
                    renderItems();
                    closeTaskModal();
                    showToast('‰ªªÂä°Â∑≤ÂàõÂª∫', 'success');
                } else {
                    showToast('ÂàõÂª∫Â§±Ë¥•', 'error');
                }
            });
        } else {
            // Êõ¥Êñ∞‰ªªÂä°
            fetch('/api/todos/' + modalTaskId, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    allItems = allItems.map(function(i) {
                        return i.id === modalTaskId ? result.item : i;
                    });
                    updateCounts();
                    renderItems();
                    closeTaskModal();
                    showToast('Â∑≤‰øùÂ≠ò', 'success');
                } else {
                    showToast('‰øùÂ≠òÂ§±Ë¥•', 'error');
                }
            });
        }
    }

    // ÂÖºÂÆπÊóßÂáΩÊï∞
    function closeTaskCard() {
        closeTaskModal();
    }

    function hideAddModal(e) {
        closeTaskModal();
    }

    function getQuadrantName(quadrant) {
        var names = {
            'important-urgent': 'üî• ‰ºòÂÖàÂ§ÑÁêÜ',
            'important-not-urgent': 'üéØ Â∞±Á≠â‰Ω†ÁøªÁâåÂ≠ê‰∫Ü',
            'not-important-urgent': 'üì• ÂæÖÂàÜÁ±ª',
            'not-important-not-urgent': '‚ö° Áü≠Âπ≥Âø´'
        };
        return names[quadrant] || quadrant;
    }

    function getTabName(tab) {
        var names = {
            'today': 'Today',
            'week': 'This Week',
            'month': 'Next 30 Days'
        };
        return names[tab] || tab;
    }

    function formatDateTime(isoString) {
        if (!isoString) return '-';
        var date = new Date(isoString);
        var m = (date.getMonth() + 1).toString().padStart(2, '0');
        var d = date.getDate().toString().padStart(2, '0');
        var h = date.getHours().toString().padStart(2, '0');
        var min = date.getMinutes().toString().padStart(2, '0');
        return m + '-' + d + ' ' + h + ':' + min;
    }

    function formatDate(dateString) {
        if (!dateString) return '-';
        var date = new Date(dateString);
        var y = date.getFullYear();
        var m = (date.getMonth() + 1).toString().padStart(2, '0');
        var d = date.getDate().toString().padStart(2, '0');
        return y + '-' + m + '-' + d;
    }

    function editTaskFromCard() {
        // Â∑≤Ë¢´Áªü‰∏ÄÂºπÁ™óÂèñ‰ª£ÔºåËøô‰∏™ÂáΩÊï∞‰øùÁïôÂÖºÂÆπÊÄß
        if (modalTaskItem) {
            switchToEditMode();
        }
    }

    // ÊòæÁ§∫ÁºñËæëÂºπÁ™ó
    function showEditDialog(item) {
        var overlay = document.createElement('div');
        overlay.className = 'progress-dialog-overlay';
        overlay.innerHTML =
            '<div class="edit-dialog">' +
                '<div class="edit-dialog-title">ÁºñËæë‰ªªÂä°</div>' +
                '<div class="edit-form">' +
                    '<div class="edit-field">' +
                        '<label>‰ªªÂä°ÂÜÖÂÆπ</label>' +
                        '<textarea id="edit-text" rows="3">' + escapeHtml(item.text) + '</textarea>' +
                    '</div>' +
                    '<div class="edit-row">' +
                        '<div class="edit-field">' +
                            '<label>Áõ∏ÂÖ≥‰∫∫</label>' +
                            '<input type="text" id="edit-assignee" value="' + (item.assignee || '') + '" placeholder="ËæìÂÖ•Áõ∏ÂÖ≥‰∫∫">' +
                        '</div>' +
                        '<div class="edit-field">' +
                            '<label>ËÆ°ÂàíÂÆåÊàêÊó∂Èó¥</label>' +
                            '<input type="date" id="edit-due-date" value="' + (item.due_date || '') + '">' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="progress-dialog-buttons">' +
                    '<button class="progress-btn cancel" id="edit-cancel">ÂèñÊ∂à</button>' +
                    '<button class="progress-btn confirm" id="edit-save">‰øùÂ≠ò</button>' +
                '</div>' +
            '</div>';

        document.body.appendChild(overlay);

        // ÂèñÊ∂àÊåâÈíÆ
        document.getElementById('edit-cancel').addEventListener('click', function() {
            document.body.removeChild(overlay);
        });

        // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
        overlay.addEventListener('click', function(e) {
            if (e.target === overlay) {
                document.body.removeChild(overlay);
            }
        });

        // ‰øùÂ≠òÊåâÈíÆ
        document.getElementById('edit-save').addEventListener('click', function() {
            var newText = document.getElementById('edit-text').value.trim();
            var newAssignee = document.getElementById('edit-assignee').value.trim();
            var newDueDate = document.getElementById('edit-due-date').value || null;

            if (!newText) {
                showToast('‰ªªÂä°ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫', 'error');
                return;
            }

            fetch('/api/todos/' + item.id, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    text: newText,
                    assignee: newAssignee,
                    due_date: newDueDate
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    allItems = allItems.map(function(i) {
                        return i.id === item.id ? data.item : i;
                    });
                    renderItems();
                    showToast('Â∑≤‰øùÂ≠ò', 'success');
                    document.body.removeChild(overlay);
                }
            });
        });
    }

    // ESC ÈîÆÂÖ≥Èó≠ÂºπÁ™ó
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeTaskModal();
        }
    });

    // ËøõÂ∫¶ÊªëÂùóÊõ¥Êñ∞
    document.getElementById('modal-progress').addEventListener('input', function(e) {
        var val = e.target.value;
        document.getElementById('modal-progress-value').textContent = val + '%';
        e.target.style.setProperty('--val', val + '%');
    });

    // Ë±°ÈôêÈÄâÊã©
    document.querySelectorAll('.q-option').forEach(function(opt) {
        opt.addEventListener('click', function() {
            if (modalMode === 'view') return;
            document.querySelectorAll('.q-option').forEach(function(o) {
                o.classList.remove('selected');
            });
            opt.classList.add('selected');
            opt.querySelector('input').checked = true;
        });
    });

    // Êó∂Èó¥ÊÆµÊåâÈíÆÁÇπÂáª
    document.querySelectorAll('#modal-tab-buttons .tab-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            if (modalMode === 'view') return;
            document.querySelectorAll('#modal-tab-buttons .tab-btn').forEach(function(b) {
                b.classList.remove('selected');
            });
            btn.classList.add('selected');
        });
    });

    // Tag management for modal (deprecated - keeping for compatibility)
    var modalTags = [];

    function addTagToModal(tag) {
        tag = tag.trim();
        if (!tag || modalTags.includes(tag)) return;
        modalTags.push(tag);
        renderModalTags();
    }

    function removeTagFromModal(tag) {
        modalTags = modalTags.filter(function(t) { return t !== tag; });
        renderModalTags();
    }

    function renderModalTags() {
        var container = document.getElementById('tag-input-container');
        var input = document.getElementById('tag-input');
        // Remove existing tag chips
        container.querySelectorAll('.tag-chip').forEach(function(el) { el.remove(); });
        // Add tag chips before input
        modalTags.forEach(function(tag) {
            var chip = document.createElement('span');
            chip.className = 'tag-chip';
            chip.innerHTML = escapeHtml(tag) + ' <span class="tag-chip-remove" onclick="removeTagFromModal(\'' + escapeHtml(tag) + '\')">&times;</span>';
            container.insertBefore(chip, input);
        });
    }

    // Tag input handling (deprecated - element removed)
    var tagInput = document.getElementById('tag-input');
    if (tagInput) {
        tagInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                addTagToModal(this.value);
                this.value = '';
            } else if (e.key === 'Backspace' && !this.value && modalTags.length > 0) {
                modalTags.pop();
                renderModalTags();
            }
        });
    }

    // Quadrant selector (new grid style)
    document.querySelectorAll('.quadrant-cell').forEach(function(opt) {
        opt.addEventListener('click', function() {
            document.querySelectorAll('.quadrant-cell').forEach(function(o) {
                o.classList.remove('selected');
            });
            opt.classList.add('selected');
            opt.querySelector('input').checked = true;
        });
    });

    function toggleSidebarSection(sectionId) {
        var section = document.getElementById(sectionId);
        if (section) {
            section.classList.toggle('expanded');
        }
    }

    function showToast(message, type) {
        AppUtils.showToast(message, type);
    }

    // Touch Drag and Drop Support
    var touchDragItem = null;
    var touchDragClone = null;
    var touchStartX = 0;
    var touchStartY = 0;
    var touchIsDragging = false;
    var touchDragThreshold = 10;

    function startTouchDrag(e) {
        var taskItem = e.target.closest('.task-item');
        if (!taskItem || taskItem.classList.contains('completed')) return;

        var touch = e.touches[0];
        touchStartX = touch.clientX;
        touchStartY = touch.clientY;
        touchDragItem = taskItem;
        touchIsDragging = false;

        // Long press to start drag
        touchDragItem.longPressTimer = setTimeout(function() {
            if (touchDragItem) {
                touchIsDragging = true;
                startTouchDragVisual(touch);
                if (navigator.vibrate) navigator.vibrate(50);
            }
        }, 300);
    }

    function startTouchDragVisual(touch) {
        touchDragClone = document.createElement('div');
        touchDragClone.className = 'drag-clone';
        touchDragClone.textContent = touchDragItem.querySelector('.task-text').textContent;
        touchDragClone.style.left = touch.clientX + 'px';
        touchDragClone.style.top = touch.clientY + 'px';
        document.body.appendChild(touchDragClone);

        touchDragItem.classList.add('touch-dragging');
        document.getElementById('tab-drop-zones').style.display = 'flex';
        document.querySelectorAll('.tab-drop-zone').forEach(function(zone) {
            zone.style.display = zone.dataset.targetTab === currentTab ? 'none' : 'flex';
        });
    }

    function onTouchMove(e) {
        if (!touchDragItem) return;

        var touch = e.touches[0];
        var dx = touch.clientX - touchStartX;
        var dy = touch.clientY - touchStartY;

        if (!touchIsDragging && (Math.abs(dx) > touchDragThreshold || Math.abs(dy) > touchDragThreshold)) {
            clearTimeout(touchDragItem.longPressTimer);
        }

        if (touchIsDragging && touchDragClone) {
            e.preventDefault();
            touchDragClone.style.left = touch.clientX + 'px';
            touchDragClone.style.top = touch.clientY + 'px';
            highlightQuadrantUnderCursor(touch.clientX, touch.clientY);
        }
    }

    function onTouchEnd(e) {
        if (touchDragItem) {
            clearTimeout(touchDragItem.longPressTimer);
        }

        if (touchIsDragging && touchDragItem) {
            var touch = e.changedTouches[0];
            var elements = document.elementsFromPoint(touch.clientX, touch.clientY);
            var targetQuadrant = null;
            var targetTab = null;
            var itemId = touchDragItem.dataset.id;

            for (var i = 0; i < elements.length; i++) {
                var dq = elements[i].closest('.drop-quadrant');
                if (dq) {
                    targetTab = dq.dataset.targetTab;
                    targetQuadrant = dq.dataset.targetQuadrant;
                    break;
                }
                var tz = elements[i].closest('.tab-drop-zone');
                if (tz && !elements[i].closest('.drop-quadrant')) {
                    targetTab = tz.dataset.targetTab;
                    break;
                }
                var q = elements[i].closest('.quadrant');
                if (q) {
                    targetQuadrant = q.dataset.quadrant;
                    break;
                }
            }

            if (targetTab && targetQuadrant) {
                moveToTabAndQuadrant(itemId, targetTab, targetQuadrant);
            } else if (targetTab) {
                moveToTab(itemId, targetTab);
            } else if (targetQuadrant) {
                moveToQuadrant(itemId, targetQuadrant);
            }
        }

        // Cleanup
        if (touchDragClone) {
            touchDragClone.remove();
            touchDragClone = null;
        }
        if (touchDragItem) {
            touchDragItem.classList.remove('touch-dragging');
            touchDragItem = null;
        }
        touchIsDragging = false;
        endDrag();
    }

    function attachTouchHandlers() {
        document.querySelectorAll('.task-item:not(.completed)').forEach(function(item) {
            item.addEventListener('touchstart', startTouchDrag, { passive: false });
        });
    }

    // ÊØõÁéªÁíÉ Tooltip ÂäüËÉΩ
    var glassTooltip = null;
    var tooltipTimer = null;
    var TOOLTIP_DELAY = 500; // ÊÇ¨ÊµÆÂª∂ËøüÊó∂Èó¥ÔºàÊØ´ÁßíÔºâ

    function initTooltip() {
        if (!glassTooltip) {
            glassTooltip = document.createElement('div');
            glassTooltip.className = 'glass-tooltip';
            document.body.appendChild(glassTooltip);
        }
    }

    function showTooltip(text, x, y) {
        if (!glassTooltip) initTooltip();
        glassTooltip.textContent = text;

        // ËÆ°ÁÆó‰ΩçÁΩÆÔºåÁ°Æ‰øù‰∏çË∂ÖÂá∫Â±èÂπï
        var tooltipRect = glassTooltip.getBoundingClientRect();
        var maxX = window.innerWidth - 320;
        var maxY = window.innerHeight - 100;

        glassTooltip.style.left = Math.min(x, maxX) + 'px';
        glassTooltip.style.top = Math.min(y + 10, maxY) + 'px';
        glassTooltip.classList.add('visible');
    }

    function hideTooltip() {
        if (glassTooltip) {
            glassTooltip.classList.remove('visible');
        }
        if (tooltipTimer) {
            clearTimeout(tooltipTimer);
            tooltipTimer = null;
        }
    }

    function attachTooltipHandlers() {
        document.querySelectorAll('.task-text').forEach(function(textEl) {
            // Ê£ÄÊü•ÊñáÂ≠óÊòØÂê¶Ë¢´Êà™Êñ≠
            textEl.addEventListener('mouseenter', function(e) {
                var el = e.target;
                // Âè™ÊúâÂΩìÊñáÂ≠óË¢´Êà™Êñ≠Êó∂ÊâçÊòæÁ§∫ tooltip
                if (el.scrollWidth > el.clientWidth) {
                    var rect = el.getBoundingClientRect();
                    tooltipTimer = setTimeout(function() {
                        showTooltip(el.textContent, rect.left, rect.bottom);
                    }, TOOLTIP_DELAY);
                }
            });

            textEl.addEventListener('mouseleave', hideTooltip);
            textEl.addEventListener('mousedown', hideTooltip);
        });
    }

    document.addEventListener('touchmove', onTouchMove, { passive: false });
    document.addEventListener('touchend', onTouchEnd);

    // Gesture navigation (swipe between tabs)
    var gestureStartX = 0;
    var gestureStartY = 0;
    var gestureHint = document.getElementById('gesture-hint');

    document.querySelector('.eisenhower-matrix').addEventListener('touchstart', function(e) {
        if (e.target.closest('.task-item')) return;
        gestureStartX = e.touches[0].clientX;
        gestureStartY = e.touches[0].clientY;
    }, { passive: true });

    document.querySelector('.eisenhower-matrix').addEventListener('touchend', function(e) {
        if (e.target.closest('.task-item')) return;
        var dx = e.changedTouches[0].clientX - gestureStartX;
        var dy = e.changedTouches[0].clientY - gestureStartY;

        if (Math.abs(dx) > 80 && Math.abs(dx) > Math.abs(dy) * 2) {
            var tabs = ['today', 'week', 'month'];
            var currentIndex = tabs.indexOf(currentTab);

            if (dx < 0 && currentIndex < tabs.length - 1) {
                // Swipe left -> next tab
                switchTab(tabs[currentIndex + 1]);
                showGestureHint('‚Üí ' + getTabName(tabs[currentIndex + 1]));
            } else if (dx > 0 && currentIndex > 0) {
                // Swipe right -> previous tab
                switchTab(tabs[currentIndex - 1]);
                showGestureHint('‚Üê ' + getTabName(tabs[currentIndex - 1]));
            }
        }
    }, { passive: true });

    function showGestureHint(text) {
        if (!gestureHint) return;
        gestureHint.textContent = text;
        gestureHint.classList.add('visible');
        setTimeout(function() {
            gestureHint.classList.remove('visible');
        }, 1000);
    }

    // Initialize
    console.log('=== Todo page loaded (v12 - simplified) ===');
    loadQuadrantState();  // Âä†ËΩΩË±°ÈôêÊäòÂè†Áä∂ÊÄÅ
    loadItems();
    loadRoutines();  // Âä†ËΩΩ‰æãË°å‰ªªÂä°‰ª•Êõ¥Êñ∞ÊåâÈíÆÂä®Êïà
    </script>

    <!-- Daily Review Button (F601) -->
    <button class="daily-review-trigger" onclick="showDailyReview()" title="ÊØèÊó•ÂõûÈ°æ (R)">üìä</button>

    <!-- Daily Review Modal (F601) -->
    <div class="daily-review-modal" id="daily-review-modal" onclick="hideDailyReview(event)">
        <div class="daily-review-content" onclick="event.stopPropagation()">
            <div class="daily-review-header" id="review-header">‰ªäÊó•ÂõûÈ°æ</div>
            <div class="daily-review-date" id="review-date"></div>
            <div class="daily-review-stats">
                <div class="review-stat">
                    <div class="review-stat-value success" id="review-completed">0</div>
                    <div class="review-stat-label">Â∑≤ÂÆåÊàê</div>
                </div>
                <div class="review-stat">
                    <div class="review-stat-value" id="review-pending">0</div>
                    <div class="review-stat-label">ÂæÖÂÆåÊàê</div>
                </div>
            </div>
            <div class="daily-review-message" id="review-message"></div>
            <div class="daily-review-tasks" id="review-tasks"></div>
            <button class="daily-review-close" onclick="hideDailyReview()">ÁªßÁª≠Âä†Ê≤π</button>
        </div>
    </div>

    <script>
    // F601: Daily Review functionality
    function showDailyReview() {
        var today = new Date();
        var dateStr = today.getFullYear() + 'Âπ¥' + (today.getMonth() + 1) + 'Êúà' + today.getDate() + 'Êó•';
        document.getElementById('review-date').textContent = dateStr;

        // Calculate stats for today's tasks
        var todayItems = allItems.filter(function(item) { return item.tab === 'today'; });
        var completed = todayItems.filter(function(item) { return item.completed; });
        var pending = todayItems.filter(function(item) { return !item.completed; });

        document.getElementById('review-completed').textContent = completed.length;
        document.getElementById('review-pending').textContent = pending.length;

        // Generate message based on completion
        var messages = [];
        var rate = todayItems.length > 0 ? (completed.length / todayItems.length * 100).toFixed(0) : 0;

        if (rate >= 100) {
            messages = ['Â§™Ê£í‰∫ÜÔºÅ‰ªäÊó•‰ªªÂä°ÂÖ®ÈÉ®ÂÆåÊàêÔºÅ', 'ÂÆåÁæéÁöÑ‰∏ÄÂ§©ÔºÅÊâÄÊúâ‰ªªÂä°ÈÉΩÊêûÂÆö‰∫ÜÔºÅ', '‰Ω†ÊòØÊïàÁéá‰πãÁéãÔºÅ'];
        } else if (rate >= 80) {
            messages = ['ÈùûÂ∏∏Âá∫Ëâ≤ÔºÅÂÆåÊàê‰∫ÜÂ§ßÈÉ®ÂàÜ‰ªªÂä°ÔºÅ', 'ÂæàÊé•ËøëÁõÆÊ†á‰∫ÜÔºåÁªßÁª≠‰øùÊåÅÔºÅ'];
        } else if (rate >= 50) {
            messages = ['ÂÆåÊàê‰∫Ü‰∏ÄÂçä‰ªªÂä°ÔºåÁªßÁª≠Âä™ÂäõÔºÅ', 'Á®≥Ê≠•ÂâçËøõÔºå‰Ω†ÂèØ‰ª•ÁöÑÔºÅ'];
        } else if (rate > 0) {
            messages = ['ËøàÂá∫‰∫ÜÁ¨¨‰∏ÄÊ≠•ÔºåÊòéÂ§©Êõ¥Ëøõ‰∏ÄÊ≠•ÔºÅ', 'ÊØè‰∏ÄÁÇπËøõÊ≠•ÈÉΩÂÄºÂæóËÇØÂÆöÔºÅ'];
        } else if (todayItems.length === 0) {
            messages = ['‰ªäÂ§©ËøòÊ≤°Êúâ‰ªªÂä°ÔºåÊ∑ªÂä†‰∏Ä‰∏™ÂºÄÂßãÂêßÔºÅ'];
        } else {
            messages = ['‰ºëÊÅØ‰πüÊòØ‰∏∫‰∫ÜÊõ¥Â•ΩÁöÑÂá∫ÂèëÔºÅ', 'ÊòéÂ§©ÊòØÊñ∞ÁöÑÂºÄÂßãÔºÅ'];
        }
        document.getElementById('review-message').textContent = messages[Math.floor(Math.random() * messages.length)];

        // Show completed tasks
        var tasksHtml = '';
        completed.forEach(function(item) {
            tasksHtml += '<div class="review-task-item"><span class="review-task-check">‚úì</span><span>' + escapeHtml(item.text) + '</span></div>';
        });
        document.getElementById('review-tasks').innerHTML = tasksHtml || '<div style="text-align:center;color:var(--text-muted);">ÊöÇÊó†ÂÆåÊàêÁöÑ‰ªªÂä°</div>';

        document.getElementById('daily-review-modal').classList.add('visible');
    }

    function hideDailyReview(e) {
        if (e && e.target !== document.getElementById('daily-review-modal')) return;
        document.getElementById('daily-review-modal').classList.remove('visible');
    }

    // Add keyboard shortcut R for daily review
    document.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        if (e.key === 'r' || e.key === 'R') {
            showDailyReview();
        }
    });
    </script>

{% endblock %}
